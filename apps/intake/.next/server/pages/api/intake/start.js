"use strict";(()=>{var a={};a.id=778,a.ids=[778],a.modules={1046:(a,b,c)=>{c.d(b,{FS:()=>i,RE:()=>f,Y2:()=>j,at:()=>g,n4:()=>h});var d=c(5511),e=c.n(d);function f(a){let b=a.headers["x-request-id"]??a.headers["x-correlation-id"];if(Array.isArray(b)){let a=b.find(a=>a.trim());if(a)return a.trim()}return"string"==typeof b&&b.trim()?b.trim():e().randomUUID()}function g(a,b){let c=a.url?a.url.split("?")[0]:"";console.info(`[intake-api] ${a.method??"UNKNOWN"} ${c} requestId=${b}`)}function h(a,b,c,d,e){let f=e?` detail="${e}"`:"";return console.error(`[intake-api] requestId=${d} status=${b} message="${c}"${f}`),a.status(b).json({ok:!1,error:c,requestId:d})}function i(a,b,c,d){return!!a.method&&!!c.includes(a.method)||(b.setHeader("Allow",c),h(b,405,"Method not allowed",d),!1)}function j(a,b,c={}){let d=c.limitBytes??1048576,e=a.body??(c.allowEmpty?{}:void 0);if(void 0===e)return{ok:!1,status:400,error:"Request body required"};if("string"==typeof e){if(Buffer.byteLength(e,"utf8")>d)return{ok:!1,status:413,error:"Request body too large"};try{return{ok:!0,data:JSON.parse(e)}}catch{return{ok:!1,status:400,error:"Invalid JSON body"}}}return Buffer.byteLength(JSON.stringify(e),"utf8")>d?{ok:!1,status:413,error:"Request body too large"}:{ok:!0,data:e}}},2977:(a,b,c)=>{c.d(b,{C:()=>i,x:()=>j});var d=c(5511),e=c.n(d);let f=function(a){let b=process.env[a];if(!b)throw Error(`Missing ${a}`);return b}("INTAKE_TOKEN_SECRET");function g(a){return("string"==typeof a?Buffer.from(a,"utf8"):a).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function h(a){return g(e().createHmac("sha256",f).update(a).digest())}function i(a){let b=Math.floor(Date.now()/1e3)+(a.expiresInSeconds??2592e3),c=g(JSON.stringify({firm_id:a.firmId,intake_id:a.intakeId,exp:b,v:1})),d=h(c);return`${c}.${d}`}function j(a){let b,c=a.split(".");if(2!==c.length)return{ok:!1,status:401,error:"Invalid intake token"};let[d,f]=c,g=h(d),i=Buffer.from(f,"utf8"),j=Buffer.from(g,"utf8");if(i.length!==j.length||!e().timingSafeEqual(i,j))return{ok:!1,status:401,error:"Invalid intake token"};try{b=JSON.parse((function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=b.padEnd(4*Math.ceil(b.length/4),"=");return Buffer.from(c,"base64")})(d).toString("utf8"))}catch{return{ok:!1,status:401,error:"Invalid intake token"}}return b.firm_id&&b.intake_id&&"number"==typeof b.exp&&1===b.v?b.exp<=Math.floor(Date.now()/1e3)?{ok:!1,status:403,error:"Intake token expired"}:{ok:!0,payload:b}:{ok:!1,status:401,error:"Invalid intake token"}}},3721:a=>{a.exports=import("@supabase/supabase-js")},3915:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(4756),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/intake/start",pathname:"/api/intake/start",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/intake/start"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/intake/start",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},4756:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>j});var e=c(7489),f=c(2977),g=c(1046),h=a([e]);e=(h.then?(await h)():h)[0];let k=/^[a-z0-9](?:[a-z0-9-]{1,61}[a-z0-9])?$/;function i(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}async function j(a,b){let c=(0,g.RE)(a);if((0,g.at)(a,c),!(0,g.FS)(a,b,["POST"],c))return;let d=(0,g.Y2)(a,c);if(!d.ok)return void(0,g.n4)(b,d.status,d.error,c);let h=d.data??{},j="string"==typeof h.firm_slug?h.firm_slug.trim():"";if(!j)return void(0,g.n4)(b,400,"firm_slug is required",c);if(!k.test(j))return void(0,g.n4)(b,400,"Invalid firm_slug format",c);let{data:l,error:m}=await e.supabaseAdmin.from("firms").select("id, name, slug").eq("slug",j).maybeSingle();if(m)return void(0,g.n4)(b,500,"Unable to resolve firm",c);if(!l?.id)return void(0,g.n4)(b,404,"Firm not found",c);let n={firm_id:l.id,status:"draft",raw_payload:{},intake_channel:i(h.intake_channel),matter_type:i(h.matter_type),urgency_level:i(h.urgency_level),language_preference:i(h.language_preference)},{data:o,error:p}=await e.supabaseAdmin.from("intakes").insert(n).select("id").single();if(p||!o)return void(0,g.n4)(b,500,"Failed to start intake",c);let q=(0,f.C)({firmId:l.id,intakeId:o.id}),r="string"==typeof l.slug&&l.slug.trim()?l.slug.trim():j,s=`/intake/${r}/resume/${encodeURIComponent(q)}`;return b.status(200).json({ok:!0,token:q,resumePath:s})}d()}catch(a){d(a)}})},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7489:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{supabaseAdmin:()=>i});var e=c(3721),f=a([e]);e=(f.then?(await f)():f)[0];let g=process.env.SUPABASE_URL,h=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!g||!h)throw console.error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY",{hasUrl:!!g,hasKey:!!h}),Error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY");let i=(0,e.createClient)(g,h,{auth:{persistSession:!1,autoRefreshToken:!1}});d()}catch(a){d(a)}})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929],()=>b(b.s=3915));module.exports=c})();