"use strict";(()=>{var a={};a.id=618,a.ids=[618],a.modules={1046:(a,b,c)=>{c.d(b,{FS:()=>i,RE:()=>f,Y2:()=>j,at:()=>g,n4:()=>h});var d=c(5511),e=c.n(d);function f(a){let b=a.headers["x-request-id"]??a.headers["x-correlation-id"];if(Array.isArray(b)){let a=b.find(a=>a.trim());if(a)return a.trim()}return"string"==typeof b&&b.trim()?b.trim():e().randomUUID()}function g(a,b){let c=a.url?a.url.split("?")[0]:"";console.info(`[intake-api] ${a.method??"UNKNOWN"} ${c} requestId=${b}`)}function h(a,b,c,d,e){let f=e?` detail="${e}"`:"";return console.error(`[intake-api] requestId=${d} status=${b} message="${c}"${f}`),a.status(b).json({ok:!1,error:c,requestId:d})}function i(a,b,c,d){return!!a.method&&!!c.includes(a.method)||(b.setHeader("Allow",c),h(b,405,"Method not allowed",d),!1)}function j(a,b,c={}){let d=c.limitBytes??1048576,e=a.body??(c.allowEmpty?{}:void 0);if(void 0===e)return{ok:!1,status:400,error:"Request body required"};if("string"==typeof e){if(Buffer.byteLength(e,"utf8")>d)return{ok:!1,status:413,error:"Request body too large"};try{return{ok:!0,data:JSON.parse(e)}}catch{return{ok:!1,status:400,error:"Invalid JSON body"}}}return Buffer.byteLength(JSON.stringify(e),"utf8")>d?{ok:!1,status:413,error:"Request body too large"}:{ok:!0,data:e}}},1113:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(1812),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/intake/submit",pathname:"/api/intake/submit",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/intake/submit"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/intake/submit",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},1812:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>p});var e=c(7489),f=c(2977),g=c(5735),h=c(7428),i=c(2426),j=c(4518),k=c(3903),l=c(1046),m=a([e,i,k]);[e,i,k]=m.then?(await m)():m;let q=new Set(g.U.sections.flatMap(a=>a.fields.filter(a=>!a.isSystem).map(a=>a.key)));function n(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function o(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}async function p(a,b){let c=(0,l.RE)(a);if((0,l.at)(a,c),!(0,l.FS)(a,b,["POST"],c))return;let d=(0,l.Y2)(a,c);if(!d.ok)return void(0,l.n4)(b,d.status,d.error,c);let g=function(a,b){let c=a.headers.authorization;if(c?.startsWith("Bearer "))return c.slice(7).trim();let d=a.headers["x-intake-token"];if("string"==typeof d&&d.trim())return d.trim();let e=a.query.token;if("string"==typeof e&&e.trim())return e.trim();let f=b?.token;return"string"==typeof f&&f.trim()?f.trim():""}(a,d.data);if(!g)return void(0,l.n4)(b,401,"Missing intake token",c);let m=(0,f.x)(g);if(!m.ok)return void(0,l.n4)(b,m.status,m.error,c);let p=d.data??{},r="string"==typeof p.intakeId?p.intakeId:"";if(!r)return void(0,l.n4)(b,400,"intakeId is required",c);if(r!==m.payload.intake_id)return void(0,l.n4)(b,403,"Intake token does not match intake",c);let s=p.patch??{};if(!n(s))return void(0,l.n4)(b,400,"patch must be an object",c);let{sanitized:t,unknownKeys:u}=function(a){let b=[],c={};for(let[d,e]of Object.entries(a)){if(!q.has(d)){b.push(d);continue}void 0!==e&&(c[d]=e)}return{sanitized:c,unknownKeys:b}}(s);if(u.length>0)return void(0,l.n4)(b,400,`Unknown intake fields: ${u.join(", ")}`,c);let{data:v,error:w}=await e.supabaseAdmin.from("intakes").select("id, firm_id, status, submitted_at, raw_payload").eq("id",r).eq("firm_id",m.payload.firm_id).maybeSingle();if(w)return void(0,l.n4)(b,500,"Unable to load intake",c);if(!v)return void(0,l.n4)(b,404,"Intake not found",c);if(v.submitted_at||"submitted"===v.status){let a=null;try{a=await (0,i.J)({intake_id:v.id,firm_id:v.firm_id})}catch(a){console.error(`[wf3] submit hook failed intake_id=${v.id}`,a)}if(a?.extraction_id)try{let b=Number(process.env.OPENAI_MONTHLY_BUDGET_USD??"100"),c=Number(process.env.OPENAI_MAX_RETRIES??"2"),d=process.env.OPENAI_API_KEY&&v.firm_id?(0,k.J)({firmId:v.firm_id,monthlyBudgetUsd:Number.isFinite(b)?b:100,retries:Number.isFinite(c)?c:2}):void 0;await (0,j.F)({intakeId:v.id,wf3RunId:a.extraction_id},d?{llmProvider:d}:void 0)}catch(a){console.error(`[wf4] submit hook failed intake_id=${v.id}`,a)}return b.status(200).json({ok:!0,locked:!0,submitted_at:v.submitted_at})}let x={status:"submitted",submitted_at:new Date().toISOString()};if(Object.keys(t).length>0){let a=n(v.raw_payload)?v.raw_payload:{},b=(0,h.e)({...a,...t});x.raw_payload=b,void 0!==t.intake_channel&&(x.intake_channel=o(t.intake_channel)),void 0!==t.matter_type&&(x.matter_type=o(t.matter_type)),void 0!==t.urgency_level&&(x.urgency_level=o(t.urgency_level)),void 0!==t.language_preference&&(x.language_preference=o(t.language_preference));let c=function(a){let b=o(a.client_first_name),c=o(a.client_last_name);return(b||c)&&[b,c].filter(Boolean).join(" ").trim()||null}(b);c&&(x.client_display_name=c)}let{data:y,error:z}=await e.supabaseAdmin.from("intakes").update(x).eq("id",r).eq("firm_id",m.payload.firm_id).is("submitted_at",null).select("id, submitted_at").maybeSingle();if(z)return z.message.includes("INTAKE_IMMUTABLE")?b.status(409).json({ok:!1,locked:!0,requestId:c}):void(0,l.n4)(b,500,"Unable to submit intake",c);if(!y)return b.status(409).json({ok:!1,locked:!0,requestId:c});let A=null;try{A=await (0,i.J)({intake_id:r,firm_id:m.payload.firm_id})}catch(a){console.error(`[wf3] submit hook failed intake_id=${r}`,a)}if(A?.extraction_id)try{let a=Number(process.env.OPENAI_MONTHLY_BUDGET_USD??"100"),b=Number(process.env.OPENAI_MAX_RETRIES??"2"),c=process.env.OPENAI_API_KEY&&m.payload.firm_id?(0,k.J)({firmId:m.payload.firm_id,monthlyBudgetUsd:Number.isFinite(a)?a:100,retries:Number.isFinite(b)?b:2}):void 0;await (0,j.F)({intakeId:r,wf3RunId:A.extraction_id},c?{llmProvider:c}:void 0)}catch(a){console.error(`[wf4] submit hook failed intake_id=${r}`,a)}return b.status(200).json({ok:!0,locked:!0,submitted_at:y.submitted_at})}d()}catch(a){d(a)}})},2426:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{J:()=>o});var e=c(7489),f=c(4748),g=c(3540),h=c(6453),i=c(9268),j=a([e,i]);function k(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function l(a,b){let c=b.map(b=>{var c;return c=a[b],Array.isArray(c)?c:null==c||""===c?[]:[c]}),d=c.reduce((a,b)=>Math.max(a,b.length),0);if(0===d)return[];let e=[];for(let a=0;a<d;a+=1){let d={},f=!1;b.forEach((b,e)=>{let g=c[e][a];void 0!==g&&(d[b]=g),null!=g&&("string"==typeof g?g.trim().length>0:!Array.isArray(g)||g.length>0)&&(f=!0)}),f&&e.push(d)}return e}async function m(a){let{data:b,error:c}=await e.supabaseAdmin.from("intakes").select("id, firm_id, status, submitted_at, raw_payload").eq("id",a).maybeSingle();if(c)throw Error("Unable to load intake");if(!b)throw Error("Intake not found");return b}async function n(a,b){let{data:c,error:d}=await e.supabaseAdmin.from("intake_extractions").select("id, version, extracted_data, schema_version, created_at").eq("intake_id",a).eq("extracted_data->rules_engine->>ruleset_version",b).order("version",{ascending:!1}).limit(1).maybeSingle();if(d)throw Error("Unable to query existing rules evaluation");if(!c)return null;let f=c.extracted_data;return f?.rules_engine?{...c,rules_engine:f.rules_engine}:null}async function o(a){let b=await m(a.intake_id);if(a.firm_id&&a.firm_id!==b.firm_id)throw Error("Intake firm mismatch");if(!b.submitted_at&&"submitted"!==b.status)throw Error("Intake is not submitted");let{catalog:c,ruleset_version:d}=(0,g.Uv)(),e=a.force?null:await n(b.id,d);if(e)return{evaluation:e.rules_engine,ruleset_version:d,written:!1,extraction_id:e.id,version:e.version};let j=k(b.raw_payload)?b.raw_payload:{},o=function(a){let b={...a};if(!Array.isArray(a.children)||0===a.children.length){let c=l(a,["child_full_name","child_dob","child_current_residence","biological_relation","special_needs"]);c.length>0&&(b.children=c)}if(!Array.isArray(a.assets)||0===a.assets.length){let c=l(a,["asset_type","ownership","estimated_value","title_holder","acquired_pre_marriage"]);c.length>0&&(b.assets=c)}if(!Array.isArray(a.debts)||0===a.debts.length){let c=l(a,["debt_type","amount","responsible_party","incurred_during_marriage"]);c.length>0&&(b.debts=c)}let c=k(a.children_custody)?{...a.children_custody}:{};return["custody_type_requested","parenting_plan_exists","modification_existing_order","current_parenting_schedule","school_district"].forEach(b=>{void 0!==a[b]&&void 0===c[b]&&(c[b]=a[b])}),Object.keys(c).length>0&&(b.children_custody=c),b}(j),p=(0,f.P)(),q=(0,h.F)(o,c,p),r=await (0,i.T)(b.id,q);return console.info(`[wf3] intake_id=${b.id} ruleset=${d} version=${r.version}`),{evaluation:q,ruleset_version:d,written:!0,extraction_id:r.id,version:r.version}}[e,i]=j.then?(await j)():j,d()}catch(a){d(a)}})},2977:(a,b,c)=>{c.d(b,{C:()=>i,x:()=>j});var d=c(5511),e=c.n(d);let f=function(a){let b=process.env[a];if(!b)throw Error(`Missing ${a}`);return b}("INTAKE_TOKEN_SECRET");function g(a){return("string"==typeof a?Buffer.from(a,"utf8"):a).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function h(a){return g(e().createHmac("sha256",f).update(a).digest())}function i(a){let b=Math.floor(Date.now()/1e3)+(a.expiresInSeconds??2592e3),c=g(JSON.stringify({firm_id:a.firmId,intake_id:a.intakeId,exp:b,v:1})),d=h(c);return`${c}.${d}`}function j(a){let b,c=a.split(".");if(2!==c.length)return{ok:!1,status:401,error:"Invalid intake token"};let[d,f]=c,g=h(d),i=Buffer.from(f,"utf8"),j=Buffer.from(g,"utf8");if(i.length!==j.length||!e().timingSafeEqual(i,j))return{ok:!1,status:401,error:"Invalid intake token"};try{b=JSON.parse((function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=b.padEnd(4*Math.ceil(b.length/4),"=");return Buffer.from(c,"base64")})(d).toString("utf8"))}catch{return{ok:!1,status:401,error:"Invalid intake token"}}return b.firm_id&&b.intake_id&&"number"==typeof b.exp&&1===b.v?b.exp<=Math.floor(Date.now()/1e3)?{ok:!1,status:403,error:"Intake token expired"}:{ok:!0,payload:b}:{ok:!1,status:401,error:"Invalid intake token"}}},3540:(a,b,c)=>{c.d(b,{Uv:()=>n});var d=c(9021),e=c.n(d),f=c(3873),g=c.n(f);function h(a){return"object"==typeof a&&null!==a&&!Array.isArray(a)}function i(a){return"string"==typeof a}function j(a,b,c){if(!Array.isArray(a))return void c.push({path:b,message:"Expected array of strings"});a.forEach((a,d)=>{i(a)||c.push({path:`${b}[${d}]`,message:"Expected string"})})}let k=g().join(function(){let a=process.cwd();if(e().existsSync(g().join(a,"docs")))return a;let b=g().resolve(a,"..","..");return e().existsSync(g().join(b,"docs"))?b:a}(),"docs","workflow 3","workflow-03-rule-catalog.json"),l=null,m=null;function n(a=k){let b=function(a=k){let b=g().resolve(a);return l&&m===b||(l=function(a){let b=function(a){let b=[];if(!h(a))throw Error("Invalid rule catalog: expected object root");let c=["ruleset_version","rules"];if(Object.keys(a).forEach(a=>{c.includes(a)||b.push({path:`root.${a}`,message:"Unexpected root key"})}),i(a.ruleset_version)||b.push({path:"root.ruleset_version",message:"Missing ruleset_version"}),Array.isArray(a.rules)){let c=new Set;a.rules.forEach((a,d)=>{!function(a,b,c,d){if(!h(a))return d.push({path:b,message:"Expected rule object"});let e=["rule_id","name","description","severity","applies_when","field_paths","message_template","evidence_strategy"];Object.keys(a).forEach(a=>{e.includes(a)||d.push({path:`${b}.${a}`,message:"Unexpected rule key"})}),i(a.rule_id)?c.has(a.rule_id)?d.push({path:`${b}.rule_id`,message:`Duplicate rule_id: ${a.rule_id}`}):c.add(a.rule_id):d.push({path:`${b}.rule_id`,message:"Missing rule_id"}),i(a.name)||d.push({path:`${b}.name`,message:"Missing name"}),i(a.description)||d.push({path:`${b}.description`,message:"Missing description"});let f=a.severity;if(i(a.severity)&&("block"===f||"warning"===f)||d.push({path:`${b}.severity`,message:"Invalid severity"}),h(a.applies_when)){let c=["all"];Object.keys(a.applies_when).forEach(a=>{c.includes(a)||d.push({path:`${b}.applies_when.${a}`,message:"Unexpected applies_when key"})});let e=a.applies_when.all;Array.isArray(e)?e.forEach((a,c)=>{let e=`${b}.applies_when.all[${c}]`;if(!h(a))return void d.push({path:e,message:"Expected condition object"});i(a.path)||d.push({path:`${e}.path`,message:"Missing condition path"}),void 0!==a.exists&&"boolean"!=typeof a.exists&&d.push({path:`${e}.exists`,message:"Expected exists boolean"});let f=["gt","gte","lt","lte"],g=f.some(b=>void 0!==a[b]);void 0!==a.exists||void 0!==a.equals||g||d.push({path:e,message:"Condition must include exists, equals, or numeric comparator"}),f.forEach(b=>{void 0!==a[b]&&"number"!=typeof a[b]&&d.push({path:`${e}.${b}`,message:"Expected number"})});let j=["path","exists","equals","gt","gte","lt","lte"];Object.keys(a).forEach(a=>{j.includes(a)||d.push({path:`${e}.${a}`,message:"Unexpected condition key"})})}):d.push({path:`${b}.applies_when.all`,message:"Expected applies_when.all array"})}else d.push({path:`${b}.applies_when`,message:"Missing applies_when"});j(a.field_paths,`${b}.field_paths`,d),i(a.message_template)||d.push({path:`${b}.message_template`,message:"Missing message_template"}),function(a,b,c){if(!h(a))return c.push({path:b,message:"Expected evidence_strategy object"});if(!i(a.type))return c.push({path:`${b}.type`,message:"Missing evidence_strategy.type"});let d={missing_or_null:["type","paths"],csv_lookup:["type","csv","input_path","match_on","output"],enum_membership:["type","path","allowed_values"],type_check:["type","path","expected_type"],date_order:["type","earlier_path","later_path","operator"]}[a.type];if(!d)return c.push({path:`${b}.type`,message:`Unsupported evidence_strategy type: ${a.type}`});switch(Object.keys(a).forEach(a=>{d.includes(a)||c.push({path:`${b}.${a}`,message:"Unexpected evidence_strategy key"})}),a.type){case"missing_or_null":return j(a.paths,`${b}.paths`,c);case"csv_lookup":return i(a.csv)||c.push({path:`${b}.csv`,message:"Expected csv string"}),i(a.input_path)||c.push({path:`${b}.input_path`,message:"Expected input_path string"}),j(a.match_on,`${b}.match_on`,c),i(a.output)||c.push({path:`${b}.output`,message:"Expected output string"});case"enum_membership":return i(a.path)||c.push({path:`${b}.path`,message:"Expected path string"}),j(a.allowed_values,`${b}.allowed_values`,c);case"type_check":return i(a.path)||c.push({path:`${b}.path`,message:"Expected path string"}),i(a.expected_type)||c.push({path:`${b}.expected_type`,message:"Expected expected_type string"});case"date_order":return i(a.earlier_path)||c.push({path:`${b}.earlier_path`,message:"Expected earlier_path string"}),i(a.later_path)||c.push({path:`${b}.later_path`,message:"Expected later_path string"}),i(a.operator)||c.push({path:`${b}.operator`,message:"Expected operator string"});default:return}}(a.evidence_strategy,`${b}.evidence_strategy`,d)}(a,`root.rules[${d}]`,c,b)})}else b.push({path:"root.rules",message:"Missing rules array"});if(b.length>0){let a=b.map(a=>`- ${a.path}: ${a.message}`).join("\n");throw Error(`Invalid rule catalog:
${a}`)}return a}(a);return{catalog:b,ruleset_version:b.ruleset_version}}(JSON.parse(e().readFileSync(b,"utf8"))).catalog,m=b),l}(a);return{catalog:b,ruleset_version:b.ruleset_version}}},3721:a=>{a.exports=import("@supabase/supabase-js")},3873:a=>{a.exports=require("path")},3903:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{J:()=>h});var e=c(7984),f=c(8339),g=a([e]);e=(g.then?(await g)():g)[0];let i={"gpt-4o":{input_per_million:2.5,output_per_million:10},"gpt-4o-mini":{input_per_million:.15,output_per_million:.6}},j={type:"object",additionalProperties:!1,required:["source_type","source_id","path_or_span","snippet"],properties:{source_type:{type:"string",enum:["field","message","document","wf3"]},source_id:{type:"string"},path_or_span:{type:"string"},snippet:{type:["string","null"]}}},k={type:"object",additionalProperties:!1,required:["item","references"],properties:{item:{type:"string"},references:{type:"array",items:{type:"string"}}}},l={[f.Mi.extract]:{name:"wf4_extract_schema_fields",schema:{type:"object",additionalProperties:!1,required:["extractions"],properties:{extractions:{type:"array",items:{type:"object",additionalProperties:!1,required:["field_key","value","value_type","confidence_score","confidence_level","confidence_rationale_code","evidence","notes_for_reviewer"],properties:{field_key:{type:"string"},value:{type:["string","number","boolean","object","array","null"]},value_type:{type:"string"},confidence_score:{type:"number"},confidence_level:{type:"string"},confidence_rationale_code:{type:"string"},evidence:{type:"array",items:j},notes_for_reviewer:{type:["string","null"]}}}}}}},[f.Mi.summary]:{name:"wf4_summarize_case_narrative",schema:{type:"object",additionalProperties:!1,required:["case_narrative"],properties:{case_narrative:{type:"object",additionalProperties:!1,required:["parties_summary","conflict_summary","goals_summary","timeline_overview"],properties:{parties_summary:{type:"string"},conflict_summary:{type:"string"},goals_summary:{type:"string"},timeline_overview:{type:["string","null"]}}}}}},[f.Mi.dv]:{name:"wf4_flags_dv_indicators",schema:{type:"object",additionalProperties:!1,required:["flags"],properties:{flags:{type:"array",items:{type:"object",additionalProperties:!1,required:["flag_key","flag_present","confidence_score","confidence_level","evidence","why_it_matters_for_review","notes_for_reviewer"],properties:{flag_key:{type:"string"},flag_present:{type:"boolean"},confidence_score:{type:"number"},confidence_level:{type:"string"},evidence:{type:"array",items:j},why_it_matters_for_review:{type:"string"},notes_for_reviewer:{type:["string","null"]}}}}}}},[f.Mi.jurisdiction]:{name:"wf4_flags_jurisdiction_complexity",schema:{type:"object",additionalProperties:!1,required:["flags"],properties:{flags:{type:"array",items:{type:"object",additionalProperties:!1,required:["flag_key","flag_present","confidence_score","confidence_level","evidence","why_it_matters_for_review","notes_for_reviewer"],properties:{flag_key:{type:"string"},flag_present:{type:"boolean"},confidence_score:{type:"number"},confidence_level:{type:"string"},evidence:{type:"array",items:j},why_it_matters_for_review:{type:"string"},notes_for_reviewer:{type:["string","null"]}}}}}}},[f.Mi.custody]:{name:"wf4_flags_custody_conflict",schema:{type:"object",additionalProperties:!1,required:["flags"],properties:{flags:{type:"array",items:{type:"object",additionalProperties:!1,required:["flag_key","flag_present","confidence_score","confidence_level","evidence","why_it_matters_for_review","notes_for_reviewer"],properties:{flag_key:{type:"string"},flag_present:{type:"boolean"},confidence_score:{type:"number"},confidence_level:{type:"string"},evidence:{type:"array",items:j},why_it_matters_for_review:{type:"string"},notes_for_reviewer:{type:["string","null"]}}}}}}},[f.Mi.consistency]:{name:"wf4_consistency_cross_field",schema:{type:"object",additionalProperties:!1,required:["inconsistencies"],properties:{inconsistencies:{type:"array",items:{type:"object",additionalProperties:!1,required:["inconsistency_key","fields_involved","summary","severity","confidence_score","evidence","notes_for_reviewer"],properties:{inconsistency_key:{type:"string"},fields_involved:{type:"array",items:{type:"string"}},summary:{type:"string"},severity:{type:"string"},confidence_score:{type:"number"},evidence:{type:"array",items:j},notes_for_reviewer:{type:["string","null"]}}}}}}},[f.Mi.countyMentions]:{name:"wf4_county_mentions",schema:{type:"object",additionalProperties:!1,required:["county_mentions","deference"],properties:{county_mentions:{type:"array",items:{type:"object",additionalProperties:!1,required:["raw_mention","suggested_county","match_type","confidence_score","evidence","notes_for_reviewer"],properties:{raw_mention:{type:"string"},suggested_county:{type:["string","null"]},match_type:{type:"string"},confidence_score:{type:"number"},evidence:{type:"array",items:j},notes_for_reviewer:{type:["string","null"]}}}},deference:{type:"object",additionalProperties:!1,required:["wf3_canonical_county_present"],properties:{wf3_canonical_county_present:{type:"boolean"},wf3_canonical_county_value:{type:"string"}}}}}},[f.Mi.documentClassify]:{name:"wf4_document_classifications",schema:{type:"object",additionalProperties:!1,required:["document_classifications"],properties:{document_classifications:{type:"array",items:{type:"object",additionalProperties:!1,required:["document_id","document_type","confidence_score","confidence_level","evidence","notes_for_reviewer"],properties:{document_id:{type:"string"},document_type:{type:["string","null"]},confidence_score:{type:"number"},confidence_level:{type:"string"},evidence:{type:"array",items:j},notes_for_reviewer:{type:["string","null"]}}}}}}},[f.Mi.reviewAttention]:{name:"wf4_review_attention_summary",schema:{type:"object",additionalProperties:!1,required:["review_attention"],properties:{review_attention:{type:"object",additionalProperties:!1,required:["high_priority_items","medium_priority_items","low_priority_items"],properties:{high_priority_items:{type:"array",items:k},medium_priority_items:{type:"array",items:k},low_priority_items:{type:"array",items:k}}}}}}};function h(a,b={}){let c=process.env.OPENAI_API_KEY;if(!c)throw Error("OPENAI_API_KEY is required for WF4 provider");let d=Number(process.env.OPENAI_REQUEST_TIMEOUT_MS??""),g=new e.default({apiKey:c,...Number.isFinite(d)&&d>0?{timeout:d}:{}}),j=function(){let a=process.env.WF4_MODEL_PRICING_JSON;if(!a)return i;try{let b=JSON.parse(a),c={...i};for(let[a,d]of Object.entries(b))d&&"number"==typeof d.input_per_million&&"number"==typeof d.output_per_million&&(c[a]=d);return c}catch{return i}}(),k=Number(process.env.OPENAI_MAX_RETRIES??""),m="number"==typeof a.retries?a.retries:Number.isFinite(k)?k:2,n=Number(process.env.OPENAI_MONTHLY_BUDGET_USD??""),o="number"==typeof a.monthlyBudgetUsd?a.monthlyBudgetUsd:Number.isFinite(n)?n:100,p=Number(process.env.OPENAI_MAX_OUTPUT_TOKENS??""),q=!1,r=null,s={prompt_tokens:0,completion_tokens:0,total_tokens:0,cost_usd:0,per_model:{}},t=async()=>{if(q)throw Error("WF4 monthly budget exceeded");let c=function(a=new Date){return new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),1)).toISOString()}();if(!r||r.monthStart!==c){let d=b.getMonthlySpendUsd?await b.getMonthlySpendUsd(a.firmId):0;r={monthStart:c,total:d}}if(r.total+s.cost_usd>=o)throw q=!0,Error("WF4 monthly budget exceeded")};return{provider:"openai",model:"per-task",getUsageSummary:()=>s,generateJson:async({promptId:a,systemPrompt:b,userPrompt:c,input:d})=>{let e=function(a){let b=process.env.OPENAI_MODEL||"gpt-4o",c=process.env.OPENAI_CLASSIFIER_MODEL||"gpt-4o-mini";return a===f.Mi.extract||a===f.Mi.consistency?b:c}(a),h=Math.max(1,m+1),i=null;for(let f=0;f<h;f+=1){await t();try{let f=await g.chat.completions.create({model:e,messages:[{role:"system",content:b},{role:"user",content:function(a,b){let c=JSON.stringify(b);return`${a}

Input JSON:
${c}`}(c,d)}],response_format:function(a){let b=l[a];return b?{type:"json_schema",json_schema:{name:b.name,schema:b.schema,strict:!0}}:{type:"json_object"}}(a),...Number.isFinite(p)&&p>0?{max_tokens:p}:{},temperature:0}),h=f.choices[0]?.message?.content;if(!h)throw Error("Empty response");!function(a,b,c,d){if(!c)return;let e=c.prompt_tokens??0,f=c.completion_tokens??0,g=c.total_tokens??e+f,h=d?e/1e6*d.input_per_million:0,i=d?f/1e6*d.output_per_million:0,j=h+i;a.prompt_tokens+=e,a.completion_tokens+=f,a.total_tokens+=g,a.cost_usd+=j,a.per_model[b]||(a.per_model[b]={prompt_tokens:0,completion_tokens:0,total_tokens:0,cost_usd:0});let k=a.per_model[b];k.prompt_tokens+=e,k.completion_tokens+=f,k.total_tokens+=g,k.cost_usd+=j}(s,e,f.usage??void 0,j[e]);let i=JSON.parse(h);return r&&r.total+s.cost_usd>=o&&(q=!0),i}catch(a){if(a instanceof Error&&"WF4 monthly budget exceeded"===a.message)throw a;i=a instanceof Error?a:Error("LLM call failed")}}throw i??Error("LLM call failed")}}}d()}catch(a){d(a)}})},4518:(a,b,c)=>{c.d(b,{F:()=>A});var d=c(5511),e=c.n(d),f=c(5735),g=c(4748);function h(a){return a.toLowerCase().replace(/\bcounty\b/g,"").replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g," ").trim()}var i=c(9021),j=c.n(i),k=c(3873),l=c.n(k);let m=null,n=null;function o(a){if(!Array.isArray(a))return{ok:!1,error:"evidence must be an array"};for(let b of a){if(!b||"object"!=typeof b)return{ok:!1,error:"evidence pointer must be object"};if("field"!==b.source_type&&"message"!==b.source_type&&"document"!==b.source_type&&"wf3"!==b.source_type)return{ok:!1,error:"evidence source_type invalid"};if("string"!=typeof b.source_id||0===b.source_id.length)return{ok:!1,error:"evidence source_id missing"};if("string"!=typeof b.path_or_span||0===b.path_or_span.length)return{ok:!1,error:"evidence path_or_span missing"};if(void 0!==b.snippet&&"string"!=typeof b.snippet)return{ok:!1,error:"evidence snippet must be string"};if(b.snippet&&b.snippet.length>200)return{ok:!1,error:"evidence snippet too long"}}return{ok:!0}}var p=c(8339);function q(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function r(a){return a?a():new Date().toISOString()}function s(a){let b=function a(b){if(null==b)return"null";if("object"!=typeof b)return JSON.stringify(b);if(Array.isArray(b))return`[${b.map(b=>a(b)).join(",")}]`;let c=Object.keys(b).sort().map(c=>`${JSON.stringify(c)}:${a(b[c])}`);return`{${c.join(",")}}`}(a);return e().createHash("sha256").update(b).digest("hex")}async function t(a){let{supabaseAdmin:b}=await Promise.resolve().then(c.bind(c,7489)),{data:d,error:e}=await b.from("intakes").select("id, firm_id, submitted_at, raw_payload, created_at").eq("id",a).maybeSingle();if(e)throw Error("Unable to load intake snapshot");if(!d)throw Error("Intake not found");if(!d.submitted_at)throw Error("Intake not submitted");let{data:f,error:g}=await b.from("intake_messages").select("id, source, content, created_at").eq("intake_id",a).order("seq",{ascending:!0});if(g)throw Error("Unable to load intake messages");let{data:h,error:i}=await b.from("intake_documents").select("id, storage_object_path, document_type, created_at").eq("intake_id",a).order("created_at",{ascending:!0});if(i)throw Error("Unable to load intake documents");let j=q(d.raw_payload)?d.raw_payload:{};return{intake_id:d.id,submission_id:d.id,structured_fields:j,free_text_fields:{},messages:(f??[]).map(a=>({message_id:a.id,role:a.source,content:a.content,created_at:a.created_at})),documents:(h??[]).map(a=>({document_id:a.id,filename:a.storage_object_path??null,mimetype:a.document_type??null,text_extract:null,created_at:a.created_at})),created_at:d.created_at,firm_id:d.firm_id}}async function u(a){let{supabaseAdmin:b}=await Promise.resolve().then(c.bind(c,7489)),{data:d,error:e}=await b.from("intake_extractions").select("id, extracted_data, created_at").eq("id",a).maybeSingle();if(e)throw Error("Unable to load WF3 snapshot");if(!d)throw Error("WF3 snapshot not found");let f=d.extracted_data,g=f?.rules_engine??null;if(!g)throw Error("WF3 snapshot missing rules_engine");return{wf3_run_id:d.id,validation_summary:{rule_results:(g.rule_evaluations??[]).map(a=>({rule_id:String(a.rule_id??""),passed:!!a.passed,field_paths:Array.isArray(a.field_paths)?a.field_paths:[],message:a.message??void 0})),required_fields_missing:Array.isArray(g.required_fields_missing)?g.required_fields_missing:[]},canonical_fields:{},created_at:d.created_at}}async function v(a){let{supabaseAdmin:b}=await Promise.resolve().then(c.bind(c,7489)),{runLog:d,runOutput:e}=a,{data:f,error:g}=await b.from("ai_runs").insert({id:d.wf4_run_id,firm_id:d.input_refs.firm_id,intake_id:d.intake_id,run_kind:"wf4",model_name:d.model_name??null,prompt_hash:d.prompt_hash??d.prompt_bundle_version,inputs:{wf3_run_id:d.wf3_run_id??null,prompt_bundle_version:d.prompt_bundle_version,prompt_hash:d.prompt_hash??null,input_hash:d.input_hash??null,per_task:d.per_task,input_refs:d.input_refs,usage:d.usage??null,cost_usd:"number"==typeof d.cost_usd?d.cost_usd:null,started_at:d.started_at,completed_at:d.completed_at,status:d.status},outputs:{run_log:d,run_output:e},status:d.status.toLowerCase()}).select("id").single();if(g||!f)throw Error("Unable to store WF4 run");return{wf4_run_id:f.id}}async function w(a){let{supabaseAdmin:b}=await Promise.resolve().then(c.bind(c,7489)),{intakeId:d,inputHash:e}=a,{data:f,error:g}=await b.from("ai_runs").select("outputs").eq("run_kind","wf4").eq("intake_id",d).contains("inputs",{input_hash:e}).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(g||!f)return null;let h=f.outputs;return h?.run_log&&h?.run_output?{runLog:h.run_log,runOutput:h.run_output}:null}async function x(a){let{supabaseAdmin:b}=await Promise.resolve().then(c.bind(c,7489)),{runLog:d,runOutput:e}=a,f=d.input_refs.firm_id;if(!f)return;let g=[],h=(a,b)=>{b?.flags&&b.flags.forEach(b=>{if(b.flag_present){var c;g.push({firm_id:f,intake_id:d.intake_id,ai_run_id:d.wf4_run_id,flag_key:b.flag_key,severity:"HIGH"===(c=b.confidence_level)?"high":"MED"===c?"medium":"low",summary:b.why_it_matters_for_review,details:{task_id:a,prompt_id:d.per_task[a]?.prompt_id??null,flag:b}})}})};if(h("wf4.flags.dv_indicators.v1",e.flags?.dv_indicators),h("wf4.flags.jurisdiction_complexity.v1",e.flags?.jurisdiction_complexity),h("wf4.flags.custody_conflict.v1",e.flags?.custody_conflict),0===g.length)return;let{error:i}=await b.from("ai_flags").insert(g);if(i)throw Error("Unable to store WF4 flags")}async function y(a){let{supabaseAdmin:b}=await Promise.resolve().then(c.bind(c,7489)),{runLog:d,runOutput:e}=a,f=d.input_refs.firm_id;if(!f)return;let g=e.document_classifications?.document_classifications??[];if(0===g.length)return;let h=g.map(a=>a.document_id).filter(a=>"string"==typeof a&&a.length>0);if(0===h.length)return;let{data:i,error:j}=await b.from("intake_documents").select("id, classification").in("id",h).eq("intake_id",d.intake_id).eq("firm_id",f);if(j||!i)throw Error("Unable to load intake documents for classification");let k=new Map;for(let a of(g.forEach(a=>{k.set(a.document_id,a)}),i)){let c=k.get(a.id);if(!c)continue;let e={...q(a.classification)?a.classification:{},wf4:{document_type:c.document_type??null,confidence_score:c.confidence_score,confidence_level:c.confidence_level,evidence:c.evidence,notes_for_reviewer:c.notes_for_reviewer??null,ai_run_id:d.wf4_run_id,task_id:"wf4.classify.documents.v1",updated_at:d.completed_at}},{error:g}=await b.from("intake_documents").update({classification:e}).eq("id",a.id).eq("firm_id",f);if(g)throw Error("Unable to store document classification")}}async function z(a,b,c){let d=p.$o[b],e=d?.system??"Use wf4.system.v1",f=d?.user??"Return JSON only.";var g=await a.generateJson({promptId:b,systemPrompt:e,userPrompt:f,input:c});if(q(g))return{ok:!0,value:g};if("string"==typeof g)try{let a=JSON.parse(g);if(!q(a))return{ok:!1,error:"Parsed output is not an object"};return{ok:!0,value:a}}catch(a){return{ok:!1,error:"Invalid JSON output"}}return{ok:!1,error:"Output is not JSON"}}async function A(a,b={}){let c=b.now??(()=>new Date().toISOString()),d=r(c),i=await (b.loadIntakeSnapshot??t)(a.intakeId),k=await (b.loadWf3Snapshot??u)(a.wf3RunId),B=p.Dy,C=function(a){let b=l().resolve((void 0)??l().join(function(){let a=process.cwd();if(j().existsSync(l().join(a,"docs")))return a;let b=l().resolve(a,"..","..");return j().existsSync(l().join(b,"docs"))?b:a}(),"docs","workflow 4","workflow-04-ai-task-catalog.json"));return m&&n===b||(m=JSON.parse(j().readFileSync(b,"utf8")),n=b),m}(),D=s({templates:p.$o,bundle:B}),E=s({intake_snapshot:i,wf3_snapshot:k,prompt_bundle_version:B,task_catalog:C,prompt_hash:D}),F=await (b.findExistingRun??w)({intakeId:i.intake_id,inputHash:E});if(F)return F;let G=e().randomUUID(),H=f.U.sections.flatMap(a=>a.fields.filter(a=>!a.isSystem).map(a=>a.key)),I=function(){let{rows:a}=(0,g.P)(),b=[],c=new Map,d=new Map;return a.forEach(a=>{let e=a.slug??a.name;b.push(e);let f=h(a.name);if(f&&c.set(f,e),a.slug){let b=h(a.slug);b&&d.set(b,e)}}),{canonicalList:b,byName:c,bySlug:d}}().canonicalList,J=b.llmProvider,K={},L={task_outputs:K},M={};if(!J){let a=r(c),e={wf4_run_id:G,intake_id:i.intake_id,wf3_run_id:k.wf3_run_id,started_at:d,completed_at:a,status:"FAIL",prompt_hash:D,input_hash:E,prompt_bundle_version:B,per_task:{},input_refs:{intake_id:i.intake_id,wf3_run_id:k.wf3_run_id,firm_id:i.firm_id??null}};return await (b.storeRun??v)({runLog:e,runOutput:L}),{runLog:e,runOutput:L}}let N={intakeSnapshot:i,wf3Snapshot:k,schemaAllowlist:H,countyReference:I,previousOutputs:L},O=0;for(let a of(console.log("[WF4] Task Catalog Length:",C.tasks?.length),C.tasks)){let b,c=a.task_id,d=p.Eu[c]??c,e=function(a,b){let c={intake_snapshot:b.intakeSnapshot,wf3_snapshot:b.wf3Snapshot};switch(a){case"wf4.extract.schema_fields.v1":return{...c,schema_allowlist:b.schemaAllowlist};case"wf4.normalize.county_mentions.v1":return{...c,reference:{ga_counties:b.countyReference}};case"wf4.review_attention.summary.v1":return{wf4_outputs:b.previousOutputs};default:return c}}(c,N),f=null;try{if(console.log(`[WF4] Running task: ${c} with prompt: ${d}`),"wf4.review_attention.summary.v1"===c&&(console.log("[WF4] Review Attention Input Keys:",Object.keys(e)),"wf4_outputs"in e)){let a=e.wf4_outputs;console.log("[WF4] Prev Output Keys:",Object.keys(a||{})),a.extractions?.extractions&&console.log("Extractions count:",a.extractions.extractions.length),a.flags?.flags&&console.log("Flags count:",a.flags.flags.length)}let a=await z(J,d,e);if(!a.ok)throw Error(a.error);f=a.value;let b={ok:!0,value:f};if("wf4.extract.schema_fields.v1"===c?b=function(a){let b=a.extractions;if(!Array.isArray(b))return{ok:!0,value:{extractions:[]}};let c=[];for(let a of b)q(a)&&"string"==typeof a.field_key&&Object.prototype.hasOwnProperty.call(a,"value")&&"string"==typeof a.value_type&&"number"==typeof a.confidence_score&&"string"==typeof a.confidence_level&&"string"==typeof a.confidence_rationale_code&&Array.isArray(a.evidence)&&(null===a.value||void 0===a.value||0!==a.evidence.length)&&o(a.evidence).ok&&c.push(a);return{ok:!0,value:{extractions:c}}}(f):"wf4.flags.dv_indicators.v1"===c||"wf4.flags.jurisdiction_complexity.v1"===c||"wf4.flags.custody_conflict.v1"===c?b=function(a){let b=a.flags;if(!Array.isArray(b))return{ok:!0,value:{flags:[]}};let c=[];for(let a of b)q(a)&&"string"==typeof a.flag_key&&"boolean"==typeof a.flag_present&&"number"==typeof a.confidence_score&&"string"==typeof a.confidence_level&&Array.isArray(a.evidence)&&(!a.flag_present||0!==a.evidence.length)&&o(a.evidence).ok&&"string"==typeof a.why_it_matters_for_review&&c.push(a);return{ok:!0,value:{flags:c}}}(f):"wf4.consistency.cross_field.v1"===c?b=function(a){let b=a.inconsistencies;if(!Array.isArray(b))return{ok:!0,value:{inconsistencies:[]}};let c=[];for(let a of b)q(a)&&"string"==typeof a.inconsistency_key&&Array.isArray(a.fields_involved)&&"string"==typeof a.summary&&"string"==typeof a.severity&&"number"==typeof a.confidence_score&&Array.isArray(a.evidence)&&0!==a.evidence.length&&o(a.evidence).ok&&c.push(a);return{ok:!0,value:{inconsistencies:c}}}(f):"wf4.normalize.county_mentions.v1"===c?b=function(a,b){let c=a.county_mentions,d=a.deference;q(d)&&d.wf3_canonical_county_present;let e={wf3_canonical_county_present:!!q(d)&&!!d.wf3_canonical_county_present,wf3_canonical_county_value:q(d)&&"string"==typeof d.wf3_canonical_county_value?d.wf3_canonical_county_value:void 0},f=[];if(Array.isArray(c))for(let a of c)!(!q(a)||"string"!=typeof a.raw_mention||"string"!=typeof a.match_type||"number"!=typeof a.confidence_score||!Array.isArray(a.evidence)||0===a.evidence.length||null!==a.suggested_county&&void 0!==a.suggested_county&&"string"!=typeof a.suggested_county||"string"==typeof a.suggested_county&&Array.isArray(b)&&b.length>0&&!b.includes(a.suggested_county))&&o(a.evidence).ok&&f.push(a);return{ok:!0,value:{county_mentions:f,deference:e}}}(f,I):"wf4.classify.documents.v1"===c?b=function(a){let b=a.document_classifications;if(!Array.isArray(b))return{ok:!0,value:{document_classifications:[]}};let c=[];for(let a of b)q(a)&&"string"==typeof a.document_id&&(null===a.document_type||void 0===a.document_type||"string"==typeof a.document_type)&&"number"==typeof a.confidence_score&&"string"==typeof a.confidence_level&&Array.isArray(a.evidence)&&(!a.document_type||0!==a.evidence.length)&&o(a.evidence).ok&&c.push(a);return{ok:!0,value:{document_classifications:c}}}(f):"wf4.summarize.case_narrative.v1"===c?b=function(a){let b=a.case_narrative;return q(b)?{ok:!0,value:{case_narrative:{parties_summary:"string"==typeof b.parties_summary?b.parties_summary:"",conflict_summary:"string"==typeof b.conflict_summary?b.conflict_summary:"",goals_summary:"string"==typeof b.goals_summary?b.goals_summary:"",timeline_overview:"string"==typeof b.timeline_overview?b.timeline_overview:void 0}}}:{ok:!0,value:{case_narrative:{parties_summary:"",conflict_summary:"",goals_summary:""}}}}(f):"wf4.review_attention.summary.v1"===c&&(b=function(a){let b=a.review_attention,c=a=>{if(!Array.isArray(a))return[];let b=[];for(let c of a)q(c)&&"string"==typeof c.item&&Array.isArray(c.references)&&(c.references.some(a=>"string"!=typeof a)||b.push(c));return b};return q(b)?{ok:!0,value:{review_attention:{high_priority_items:c(b.high_priority_items),medium_priority_items:c(b.medium_priority_items),low_priority_items:c(b.low_priority_items)}}}:{ok:!0,value:{review_attention:{high_priority_items:[],medium_priority_items:[],low_priority_items:[]}}}}(f)),!b.ok)throw Error(b.error);if(console.log(`[WF4] Task ${c} Success. Output Keys:`,Object.keys(b.value||{})),K[c]={task_id:c,prompt_id:d,status:"SUCCESS",output:b.value},"wf4.extract.schema_fields.v1"===c&&(L.extractions=b.value),"wf4.flags.dv_indicators.v1"===c&&(L.flags={...L.flags??{},dv_indicators:b.value}),"wf4.flags.jurisdiction_complexity.v1"===c&&(L.flags={...L.flags??{},jurisdiction_complexity:b.value}),"wf4.flags.custody_conflict.v1"===c&&(L.flags={...L.flags??{},custody_conflict:b.value}),"wf4.consistency.cross_field.v1"===c&&(L.inconsistencies=b.value),"wf4.normalize.county_mentions.v1"===c&&(L.county_mentions=b.value),"wf4.classify.documents.v1"===c&&(L.document_classifications=b.value),"wf4.summarize.case_narrative.v1"===c&&(L.case_narrative=b.value.case_narrative),"wf4.review_attention.summary.v1"===c){let a=b.value;L.review_attention=a,console.log(`[WF4] Review Attention Items: High=${a.review_attention?.high_priority_items?.length}`)}}catch(a){O+=1,b=a instanceof Error?a.message:"Task failed",K[c]={task_id:c,prompt_id:d,status:"FAILED",output:null,error:b}}M[c]={prompt_id:d,status:K[c].status,error:K[c].error}}let P=r(c),Q="function"==typeof J.getUsageSummary?J.getUsageSummary():void 0,R=O===C.tasks.length?"FAIL":O>0?"PARTIAL":"SUCCESS",S={wf4_run_id:G,intake_id:i.intake_id,wf3_run_id:k.wf3_run_id,started_at:d,completed_at:P,status:R,model_provider:J.provider,model_name:J.model,prompt_hash:D,input_hash:E,prompt_bundle_version:B,per_task:M,input_refs:{intake_id:i.intake_id,wf3_run_id:k.wf3_run_id,firm_id:i.firm_id??null},usage:Q,cost_usd:Q?.cost_usd};await (b.storeRun??v)({runLog:S,runOutput:L});try{await (b.storeFlags??x)({runLog:S,runOutput:L})}catch{}try{await (b.updateDocumentClassifications??y)({runLog:S,runOutput:L})}catch{}return{runLog:S,runOutput:L}}},4748:(a,b,c)=>{c.d(b,{P:()=>n});var d=c(9021),e=c.n(d),f=c(3873),g=c.n(f);let h=g().join(function(){let a=process.cwd();if(e().existsSync(g().join(a,"docs")))return a;let b=g().resolve(a,"..","..");return e().existsSync(g().join(b,"docs"))?b:a}(),"docs","ga_counties.csv"),i=null,j=null;function k(a){let b=[],c="",d=!1;for(let e=0;e<a.length;e+=1){let f=a[e];d?'"'===f?'"'===a[e+1]?(c+='"',e+=1):d=!1:c+=f:'"'===f?d=!0:","===f?(b.push(c),c=""):c+=f}return b.push(c),b}function l(a){return a.replace(/\s+/g," ").trim()}function m(a){let b=new Map,c=new Map,d=new Map;return a.forEach(a=>{a.slug&&b.set(a.slug.toLowerCase(),a),a.name&&(c.set(a.name.toLowerCase(),a),d.set(l(a.name).toLowerCase(),a))}),{rows:a,bySlug:b,byNameExact:c,byNameNormalized:d}}function n(a=h){let b=g().resolve(a);return i&&j===b||(i=function(a){let b=a.split(/\r?\n/).filter(a=>a.trim().length>0);if(0===b.length)return m([]);let c=k(b[0]??"").map(a=>a.trim()),d=new Map;c.forEach((a,b)=>{d.set(a.trim().toLowerCase(),b)});let e=a=>{for(let b of a){let a=d.get(b);if("number"==typeof a)return a}return null},f=e(["state","state_code","state_abbrev"]),g=e(["county_name","name"]),h=e(["county_display","display","county_display_name"]),i=e(["county_slug","slug"]),j=e(["county_fips","fips","county_fips_code"]),n=[];for(let a=1;a<b.length;a+=1){let d=k(b[a]??"");if(0===d.length)continue;let e=null!==f&&d[f]?l(d[f]):null;if(e&&"GA"!==e.toUpperCase())continue;let m=null!==g?l(d[g]??""):"";if(!m)continue;let o=null!==h?l(d[h]??""):"",p=null!==i?l(d[i]??""):"",q=null!==j?l(d[j]??""):"",r={};c.forEach((a,b)=>{r[a]=d[b]??""}),n.push({name:m,displayName:o||void 0,slug:p||void 0,fips:q||void 0,raw:r})}return m(n)}(e().readFileSync(b,"utf8")),j=b),i}},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6453:(a,b,c)=>{function d(a){return a.slug&&a.slug.trim().length>0?a.slug:a.name}c.d(b,{F:()=>i});let e=Symbol("wildcard");function f(a,b){let c=function(a){let b;if(!a.startsWith("$"))return[];let c=a.slice(1);c.startsWith(".")&&(c=c.slice(1));let d=[],f=/([^.\[\]]+)|\[(\d*)\]/g;for(;null!==(b=f.exec(c));)b[1]?d.push(b[1]):void 0!==b[2]&&(""===b[2]?d.push(e):d.push(Number(b[2])));return d}(b),d=[a];for(let a of c){let b=[];for(let c of d)if(null!=c){if(a===e){Array.isArray(c)&&b.push(...c);continue}if("number"==typeof a){Array.isArray(c)&&b.push(c[a]);continue}"object"==typeof c&&b.push(c[a])}if(0===(d=b).length)break}return d}function g(a){return null==a||("string"==typeof a?0===a.trim().length:!!Array.isArray(a)&&(0===a.length||a.every(a=>g(a))))}function h(a,b,c){if("number"!=typeof a||Number.isNaN(a))return!1;switch(b){case"gt":return a>c;case"gte":return a>=c;case"lt":return a<c;case"lte":return a<=c;default:return!1}}function i(a,b,c,e={}){let j=e.evaluatedAt??new Date().toISOString(),k=b.ruleset_version,l=new Set,m=[],n=[],o=[],p=new Map;return b.rules.forEach(b=>{var e;if(!(!((e=b.applies_when)&&Array.isArray(e.all))||e.all.every(b=>{let c=f(a,b.path).filter(a=>!g(a));if("boolean"==typeof b.exists&&c.length>0!==b.exists||void 0!==b.equals&&!c.some(a=>a===b.equals))return!1;let d=b.gt;if("number"==typeof d&&!c.some(a=>h(a,"gt",d)))return!1;let e=b.gte;if("number"==typeof e&&!c.some(a=>h(a,"gte",e)))return!1;let i=b.lt;if("number"==typeof i&&!c.some(a=>h(a,"lt",i)))return!1;let j=b.lte;return"number"!=typeof j||!!c.some(a=>h(a,"lte",j))})))return void o.push({rule_id:b.rule_id,severity:b.severity,passed:!0,field_paths:b.field_paths,evidence:{skipped:!0},message:"",evaluated_at:j,ruleset_version:k});let{passed:i,evidence:q,missingPaths:r,normalization:s}=function(a,b,c){if("missing_or_null"===b.evidence_strategy.type){let c=function(a,b){let c=function(a,b){let c=[];return b.forEach(b=>{let d=f(a,b);(0===d.length||d.some(a=>g(a)))&&c.push(b)}),c}(a,b.paths),d=function(a,b){let c={};return b.forEach(b=>{let d=f(a,b);if(0===d.length){c[b]=null;return}let e=d.map(a=>g(a)?null:a);c[b]=1===e.length?e[0]:e}),{paths:c}}(a,b.paths);return{passed:0===c.length,evidence:d,missingPaths:c}}(a,b.evidence_strategy);return{passed:c.passed,evidence:c.evidence,missingPaths:c.missingPaths,normalization:null}}if("enum_membership"===b.evidence_strategy.type){let c=function(a,b){let c=b.evidence_strategy;if("enum_membership"!==c.type)return{passed:!0,evidence:{}};let d=f(a,c.path).filter(a=>!g(a));if(0===d.length)return{passed:!0,evidence:{path:c.path,value:null}};let e=d.find(a=>"string"!=typeof a),h=d.find(a=>"string"==typeof a&&!c.allowed_values.includes(a)),i=1===d.length?d[0]:d;return{passed:!e&&!h,evidence:{path:c.path,value:i,allowed_values:c.allowed_values}}}(a,b);return{passed:c.passed,evidence:c.evidence,missingPaths:[],normalization:null}}if("type_check"===b.evidence_strategy.type){let c=function(a,b){let c=b.evidence_strategy;if("type_check"!==c.type)return{passed:!0,evidence:{}};let d=f(a,c.path).filter(a=>!g(a));return 0===d.length?{passed:!0,evidence:{path:c.path,value:null}}:{passed:d.every(a=>"number"===c.expected_type?"number"==typeof a&&!Number.isNaN(a):"boolean"===c.expected_type?"boolean"==typeof a:"date"===c.expected_type&&"string"==typeof a&&!Number.isNaN(Date.parse(a))),evidence:{path:c.path,value:1===d.length?d[0]:d,expected_type:c.expected_type}}}(a,b);return{passed:c.passed,evidence:c.evidence,missingPaths:[],normalization:null}}if("date_order"===b.evidence_strategy.type){let c=function(a,b){let c=b.evidence_strategy;if("date_order"!==c.type)return{passed:!0,evidence:{}};let d=f(a,c.earlier_path),e=f(a,c.later_path),h=d.find(a=>!g(a)),i=e.find(a=>!g(a));if(g(h)||g(i))return{passed:!0,evidence:{earlier_path:c.earlier_path,later_path:c.later_path,earlier_value:g(h)?null:h,later_value:g(i)?null:i,operator:c.operator}};let j=Date.parse(String(h)),k=Date.parse(String(i));if(Number.isNaN(j)||Number.isNaN(k))return{passed:!0,evidence:{earlier_path:c.earlier_path,later_path:c.later_path,earlier_value:h,later_value:i,operator:c.operator}};let l=!0;switch(c.operator){case"<=":l=j<=k;break;case"<":l=j<k;break;case">=":l=j>=k;break;case">":l=j>k;break;default:l=!0}return{passed:l,evidence:{earlier_path:c.earlier_path,later_path:c.later_path,earlier_value:h,later_value:i,operator:c.operator}}}(a,b);return{passed:c.passed,evidence:c.evidence,missingPaths:[],normalization:null}}if("csv_lookup"===b.evidence_strategy.type){let e=function(a,b,c){let e=b.evidence_strategy;if("csv_lookup"!==e.type)return{passed:!0,evidence:{},normalization:null};let h=f(a,e.input_path).find(a=>!g(a));if(null==h)return{passed:!0,evidence:{input_path:e.input_path,input_value:null},normalization:null};let i=String(h),j=function(a,b){if(!a||"string"!=typeof a)return{ok:!1,error:"Missing county value"};let c=a.trim();if(!c)return{ok:!1,error:"Missing county value"};let e=c.toLowerCase(),f=b.bySlug.get(e);if(f)return{ok:!0,normalized_value:d(f),match_strategy:"slug_exact",canonical_row:f};let g=c.toLowerCase(),h=b.byNameExact.get(g);if(h)return{ok:!0,normalized_value:d(h),match_strategy:"name_exact",canonical_row:h};let i=a.replace(/\s+/g," ").trim().toLowerCase(),j=b.byNameNormalized.get(i);return j?{ok:!0,normalized_value:d(j),match_strategy:"name_trimmed",canonical_row:j}:{ok:!1,error:"Unknown county"}}(i,c);if(!j.ok)return{passed:!1,evidence:{input_path:e.input_path,input_value:i,error:j.error,source:e.csv},normalization:null};let k={kind:"county_normalization",field_path:e.input_path,input_value:i,normalized_value:j.normalized_value,match_strategy:"slug_exact"===j.match_strategy?"slug":"name",source:e.csv};return{passed:!0,evidence:{input_path:e.input_path,input_value:i,normalized_value:j.normalized_value,match_strategy:k.match_strategy,source:e.csv},normalization:k}}(a,b,c);return{passed:e.passed,evidence:e.evidence,missingPaths:[],normalization:e.normalization}}return{passed:!0,evidence:{},missingPaths:[],normalization:null}}(a,b,c);if(r.length>0&&"missing_or_null"===b.evidence_strategy.type&&"block"===b.severity&&r.forEach(a=>l.add(a)),s&&p.set(s.field_path,s),!i){let a={rule_id:b.rule_id,severity:b.severity,message:b.message_template,field_paths:b.field_paths,evidence:q,evaluated_at:j,ruleset_version:k};"block"===b.severity?m.push(a):n.push(a)}o.push({rule_id:b.rule_id,severity:b.severity,passed:i,field_paths:b.field_paths,evidence:q,message:i?"":b.message_template,evaluated_at:j,ruleset_version:k})}),{ruleset_version:k,evaluated_at:j,required_fields_missing:Array.from(l),blocks:m,warnings:n,normalizations:Array.from(p.values()),rule_evaluations:o}}},7428:(a,b,c)=>{c.d(b,{e:()=>h});let d=new Set(c(5735).U.sections.flatMap(a=>a.fields.map(a=>a.key)));function e(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function f(a){if("string"!=typeof a)return;let b=a.trim();return b.length>0?b:void 0}function g(a,b){let c={};if(e(a)){for(let b of["line1","line2","city","state","zip"]){let d=f(a[b]);d&&(c[b]=d)}if(!c.line1){let b=f(a.freeform);b&&(c.line1=b)}}else{let b=f(a);b&&(c.line1=b)}if(b){let a=f(b.city),d=f(b.state),e=f(b.zip);a&&!c.city&&(c.city=a),d&&!c.state&&(c.state=d),e&&!c.zip&&(c.zip=e)}return Object.keys(c).length>0?c:null}function h(a){if(!e(a))return{};let b={},c={...e(a._legacy)?a._legacy:{},...e(a._legacy_notes)?a._legacy_notes:{}},f=(a,b)=>{void 0!==b&&void 0===c[a]&&(c[a]=b)};for(let[c,e]of Object.entries(a))d.has(c)&&(b[c]=e);if(void 0===b.opposing_address_known&&void 0!==a.opposing_known_address&&(b.opposing_address_known=a.opposing_known_address),void 0===b.opposing_last_known_address){let c=g(a.opposing_address);c&&(b.opposing_last_known_address=c)}else if(e(b.opposing_last_known_address)&&a.opposing_address){let c=g(a.opposing_address);c&&(b.opposing_last_known_address={...c,...b.opposing_last_known_address})}if(void 0===b.client_address){let c=g(a.client_address,{city:a.client_city,state:a.client_state,zip:a.client_zip});c&&(b.client_address=c)}else if(e(b.client_address)){let c=g(a.client_address,{city:a.client_city,state:a.client_state,zip:a.client_zip});c&&(b.client_address={...c,...b.client_address})}if(void 0===b.special_needs&&void 0!==a.child_special_needs&&(b.special_needs=a.child_special_needs),void 0===b.prior_custody_orders&&void 0!==a.prior_custody_cases&&(b.prior_custody_orders=a.prior_custody_cases),void 0===b.amount&&void 0!==a.estimated_balance&&(b.amount=a.estimated_balance),void 0===b.opposing_income_known&&void 0!==a.opposing_income_estimated){let c=a.opposing_income_estimated;"number"!=typeof c||Number.isNaN(c)||(b.opposing_income_known=!0),f("opposing_income_estimated",c)}for(let[c,e]of(void 0===b.support_requested&&"string"==typeof a.support_type&&(b.support_requested=a.support_type),"boolean"==typeof a.support_requested&&(f("support_requested_boolean",a.support_requested),"string"!=typeof b.support_requested&&(b.support_requested=null)),void 0!==a.opposing_phone&&f("opposing_phone",a.opposing_phone),void 0!==a.opposing_email&&f("opposing_email",a.opposing_email),void 0!==a.marriage_notes&&f("marriage_notes",a.marriage_notes),void 0!==a.fault_ground_detail&&f("fault_ground_detail",a.fault_ground_detail),void 0!==a.separation_status&&f("separation_status",a.separation_status),void 0!==a.child_school_info&&f("child_school_info",a.child_school_info),void 0!==a.current_order_exists&&f("current_order_exists",a.current_order_exists),void 0!==a.other_parent_involvement&&f("other_parent_involvement",a.other_parent_involvement),void 0!==a.asset_description&&f("asset_description",a.asset_description),void 0!==a.documentation_provided&&f("documentation_provided",a.documentation_provided),void 0!==a.ownership_dispute&&f("ownership_dispute",a.ownership_dispute),void 0!==a.income_notes&&f("income_notes",a.income_notes),void 0!==a.debt_description&&f("debt_description",a.debt_description),void 0!==a.estimated_balance&&f("estimated_balance",a.estimated_balance),void 0!==a.joint_debt&&f("joint_debt",a.joint_debt),void 0!==a.dv_description&&f("dv_description",a.dv_description),void 0!==a.weapons_present&&f("weapons_present",a.weapons_present),void 0!==a.venue_notes&&f("venue_notes",a.venue_notes),void 0!==a.prior_protective_orders&&f("prior_protective_orders",a.prior_protective_orders),void 0!==a.prior_case_notes&&f("prior_case_notes",a.prior_case_notes),void 0!==a.desired_custody_outcome&&f("desired_custody_outcome",a.desired_custody_outcome),void 0!==a.desired_property_outcome&&f("desired_property_outcome",a.desired_property_outcome),void 0!==a.other_requests&&f("other_requests",a.other_requests),void 0!==a.uploaded_document_links&&f("uploaded_document_links",a.uploaded_document_links),void 0!==a.evidence_notes&&f("evidence_notes",a.evidence_notes),void 0!==a.client_city&&f("client_city",a.client_city),void 0!==a.client_state&&f("client_state",a.client_state),void 0!==a.client_zip&&f("client_zip",a.client_zip),void 0!==a.opposing_known_address&&f("opposing_known_address",a.opposing_known_address),void 0!==a.opposing_address&&f("opposing_address",a.opposing_address),Object.entries(a)))d.has(c)||"_legacy_notes"===c||"_legacy"===c||f(c,e);return Object.keys(c).length>0&&(b._legacy=c),b}},7984:a=>{a.exports=import("openai")},8339:(a,b,c)=>{c.d(b,{$o:()=>g,Dy:()=>d,Eu:()=>f,Mi:()=>e});let d="v0.2",e={system:"wf4.system.v1",extract:"wf4.task.extract.schema_fields.v1",summary:"wf4.task.summarize.case_narrative.v1",dv:"wf4.task.flags.dv_indicators.v1",jurisdiction:"wf4.task.flags.jurisdiction_complexity.v1",custody:"wf4.task.flags.custody_conflict.v1",consistency:"wf4.task.consistency.cross_field.v1",countyMentions:"wf4.task.normalize.county_mentions.v1",documentClassify:"wf4.task.classify.documents.v1",reviewAttention:"wf4.task.review_attention.summary.v1"},f={"wf4.extract.schema_fields.v1":e.extract,"wf4.summarize.case_narrative.v1":e.summary,"wf4.flags.dv_indicators.v1":e.dv,"wf4.flags.jurisdiction_complexity.v1":e.jurisdiction,"wf4.flags.custody_conflict.v1":e.custody,"wf4.consistency.cross_field.v1":e.consistency,"wf4.normalize.county_mentions.v1":e.countyMentions,"wf4.classify.documents.v1":e.documentClassify,"wf4.review_attention.summary.v1":e.reviewAttention},g={[e.extract]:{id:e.extract,system:"Use wf4.system.v1",user:'Extract schema-bound fields from intake inputs using the schema allowlist. Return JSON only. Always include the "extractions" array (empty if none) and include all required keys for each item.'},[e.summary]:{id:e.summary,system:"Use wf4.system.v1",user:"Summarize the case narrative from the intake. Focus on: 1) The Parties (history, status), 2) The Conflict (core dispute), 3) The Goals (client objectives). Return JSON only."},[e.dv]:{id:e.dv,system:"Use wf4.system.v1",user:'Detect DV indicators with evidence. Return JSON only. Always include the "flags" array (empty if none) and include all required keys for each item.'},[e.jurisdiction]:{id:e.jurisdiction,system:"Use wf4.system.v1",user:'Detect jurisdiction complexity signals with evidence. Cite relevant Georgia statutes (e.g., UCCJEA, OCGA 19-9-61) in the "why_it_matters_for_review" field for each flag. Return JSON only. Always include the "flags" array (empty if none).'},[e.custody]:{id:e.custody,system:"Use wf4.system.v1",user:'Detect custody conflict signals with evidence. Cite relevant Georgia statutes (e.g., OCGA 19-9-3) in the "why_it_matters_for_review" field to contextualize the risk. Return JSON only. Always include the "flags" array (empty if none).'},[e.consistency]:{id:e.consistency,system:"Use wf4.system.v1",user:'Detect cross-field inconsistencies with evidence. Return JSON only. Always include the "inconsistencies" array (empty if none) and include all required keys for each item.'},[e.countyMentions]:{id:e.countyMentions,system:"Use wf4.system.v1",user:'Extract county mentions and suggest normalization. Return JSON only. Always include "county_mentions" (array) and "deference" (object) with required keys, even if empty.'},[e.documentClassify]:{id:e.documentClassify,system:"Use wf4.system.v1",user:'Classify intake documents with evidence. Return JSON only. Always include "document_classifications" array (empty if none) and required keys for each item.'},[e.reviewAttention]:{id:e.reviewAttention,system:"Use wf4.system.v1",user:'Summarize review attention priorities based on WF4 outputs. Return JSON only. Always include "review_attention" with high_priority_items, medium_priority_items, low_priority_items arrays (empty if none).'}}},9021:a=>{a.exports=require("fs")},9268:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{T:()=>i});var e=c(7489),f=a([e]);async function g(a){let{data:b,error:c}=await e.supabaseAdmin.from("intakes").select("id, firm_id, submitted_at, status").eq("id",a).maybeSingle();if(c)throw Error("Unable to load intake metadata");if(!b)throw Error("Intake not found");if(!b.submitted_at)throw Error("Intake is not submitted");return b}async function h(a){let{data:b,error:c}=await e.supabaseAdmin.from("intake_extractions").select("version").eq("intake_id",a).order("version",{ascending:!1}).limit(1);if(c)throw Error("Unable to determine extraction version");let d=b&&b.length>0?b[0]?.version:null;return"number"==typeof d?d+1:1}async function i(a,b,c={}){let d=await g(a),f=await h(a),j=c.schemaVersion??"ga_divorce_custody_v1",k={intake_id:a,firm_id:d.firm_id,version:f,schema_version:j,extracted_data:{rules_engine:b}},{data:l,error:m}=await e.supabaseAdmin.from("intake_extractions").insert(k).select("id, intake_id, version, schema_version, created_at").single();if(m||!l)throw Error("Unable to write rules evaluation");return l}e=(f.then?(await f)():f)[0],d()}catch(a){d(a)}})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929,539],()=>b(b.s=1113));module.exports=c})();