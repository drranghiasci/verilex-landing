"use strict";(()=>{var a={};a.id=810,a.ids=[810],a.modules={3573:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(5092),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/intake/load",pathname:"/api/intake/load",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/intake/load"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/intake/load",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},3721:a=>{a.exports=import("@supabase/supabase-js")},5092:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>j});var e=c(7489),f=c(2977),g=c(7428),h=c(1046),i=a([e]);async function j(a,b){let c=(0,h.RE)(a);if((0,h.at)(a,c),!(0,h.FS)(a,b,["GET","POST"],c))return;let d="POST"===a.method?(0,h.Y2)(a,c,{allowEmpty:!0}):{ok:!0,data:{}};if(!d.ok)return void(0,h.n4)(b,d.status,d.error,c);let i=d.data??{},j="string"==typeof a.query.intakeId?a.query.intakeId:"string"==typeof i.intakeId?i.intakeId:"",k=function(a,b){let c=a.headers.authorization;if(c?.startsWith("Bearer "))return c.slice(7).trim();let d=a.headers["x-intake-token"];if("string"==typeof d&&d.trim())return d.trim();let e=a.query.token;if("string"==typeof e&&e.trim())return e.trim();let f=b?.token;return"string"==typeof f&&f.trim()?f.trim():""}(a,i);if(!k)return void(0,h.n4)(b,401,"Missing intake token",c);let l=(0,f.x)(k);if(!l.ok)return void(0,h.n4)(b,l.status,l.error,c);let m=j||l.payload.intake_id;if(!m)return void(0,h.n4)(b,400,"intakeId is required",c);if(j&&j!==l.payload.intake_id)return void(0,h.n4)(b,403,"Intake token does not match intake",c);let{data:n,error:o}=await e.supabaseAdmin.from("intakes").select("id, firm_id, status, submitted_at, raw_payload, updated_at, created_at, matter_type, urgency_level, intake_channel, language_preference").eq("id",m).eq("firm_id",l.payload.firm_id).maybeSingle();if(o)return void(0,h.n4)(b,500,"Unable to load intake",c);if(!n)return void(0,h.n4)(b,404,"Intake not found",c);let p=!!n.submitted_at,q=e.supabaseAdmin.from("intake_messages").select("seq, source, channel, content, content_structured, created_at").eq("intake_id",n.id).eq("firm_id",l.payload.firm_id).order("seq",{ascending:!0}),r=p?Promise.resolve({data:[],error:null}):e.supabaseAdmin.from("intake_documents").select("storage_object_path, document_type, classification, created_at, mime_type, size_bytes, uploaded_by_role").eq("intake_id",n.id).eq("firm_id",l.payload.firm_id).order("created_at",{ascending:!0}),[s,t]=await Promise.all([q,r]);if(s.error)return void(0,h.n4)(b,500,"Unable to load intake messages",c);if(t.error)return void(0,h.n4)(b,500,"Unable to load intake documents",c);let u=(0,g.e)(n.raw_payload??{});return b.status(200).json({ok:!0,intake:{id:n.id,status:n.status,submitted_at:n.submitted_at,raw_payload:u,matter_type:n.matter_type,urgency_level:n.urgency_level,intake_channel:n.intake_channel,language_preference:n.language_preference,updated_at:n.updated_at,created_at:n.created_at},messages:s.data??[],documents:t.data??[],locked:p})}e=(i.then?(await i)():i)[0],d()}catch(a){d(a)}})},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929,819],()=>b(b.s=3573));module.exports=c})();