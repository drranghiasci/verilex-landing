"use strict";(()=>{var a={};a.id=977,a.ids=[977],a.modules={3721:a=>{a.exports=import("@supabase/supabase-js")},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6728:(a,b,c)=>{c.d(b,{b:()=>d});function d(a,b,c){let d=[],e={...a};for(let[a,f]of Object.entries(b)){if(!c.has(a)){d.push(a);continue}void 0!==f&&(e[a]=f)}return{merged:e,unknownKeys:d}}},7739:(a,b,c)=>{c.d(b,{l:()=>d});async function d(a,b,c,d){if(d<=0)return{startSeq:0,lastSeq:0};let{data:e,error:f}=await a.from("intake_messages").select("seq").eq("intake_id",b).eq("firm_id",c).order("seq",{ascending:!1}).limit(1).maybeSingle();if(f)throw Error("Unable to allocate message sequence");let g=("number"==typeof e?.seq?e.seq:0)+1;return{startSeq:g,lastSeq:g+d-1}}},8003:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>o});var e=c(7489),f=c(2977),g=c(7739),h=c(6728),i=c(5735),j=c(7428),k=c(1046),l=a([e]);e=(l.then?(await l)():l)[0];let p=new Set(i.U.sections.flatMap(a=>a.fields.filter(a=>!a.isSystem).map(a=>a.key)));function m(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function n(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}async function o(a,b){let c=(0,k.RE)(a);if((0,k.at)(a,c),!(0,k.FS)(a,b,["POST"],c))return;let d=(0,k.Y2)(a,c);if(!d.ok)return void(0,k.n4)(b,d.status,d.error,c);let i=function(a,b){let c=a.headers.authorization;if(c?.startsWith("Bearer "))return c.slice(7).trim();let d=a.headers["x-intake-token"];if("string"==typeof d&&d.trim())return d.trim();let e=a.query.token;if("string"==typeof e&&e.trim())return e.trim();let f=b?.token;return"string"==typeof f&&f.trim()?f.trim():""}(a,d.data);if(!i)return void(0,k.n4)(b,401,"Missing intake token",c);let l=(0,f.x)(i);if(!l.ok)return void(0,k.n4)(b,l.status,l.error,c);let o=d.data??{},q="string"==typeof o.intakeId?o.intakeId:"";if(!q)return void(0,k.n4)(b,400,"intakeId is required",c);if(q!==l.payload.intake_id)return void(0,k.n4)(b,403,"Intake token does not match intake",c);let r=o.patch??{};if(!m(r))return void(0,k.n4)(b,400,"patch must be an object",c);let s=function(a){if(void 0===a)return{rows:[]};if(!Array.isArray(a))return{error:"messages must be an array"};let b=[];for(let c of a){if(!m(c))return{error:"messages entries must be objects"};if("string"!=typeof c.source||!c.source.trim())return{error:"messages.source is required"};if("string"!=typeof c.channel||!c.channel.trim())return{error:"messages.channel is required"};if("string"!=typeof c.content||!c.content.trim())return{error:"messages.content is required"};let a=m(c.content_structured)?c.content_structured:void 0;b.push({source:c.source.trim(),channel:c.channel.trim(),content:c.content,content_structured:a})}return{rows:b}}(o.messages);if("error"in s)return void(0,k.n4)(b,400,s.error,c);let t=function(a){if(void 0===a)return{rows:[]};if(!Array.isArray(a))return{error:"documents must be an array"};let b=[];for(let c of a){if(!m(c))return{error:"documents entries must be objects"};if("string"!=typeof c.storage_object_path||!c.storage_object_path.trim())return{error:"documents.storage_object_path is required"};let a="string"==typeof c.document_type?c.document_type.trim():void 0,d=m(c.classification)?c.classification:void 0;b.push({storage_object_path:c.storage_object_path.trim(),document_type:a,classification:d})}return{rows:b}}(o.documents);if("error"in t)return void(0,k.n4)(b,400,t.error,c);let{merged:u,unknownKeys:v}=(0,h.b)({},r,p);if(v.length>0)return void(0,k.n4)(b,400,`Unknown intake fields: ${v.join(", ")}`,c);if(0===Object.keys(u).length&&0===s.rows.length&&0===t.rows.length)return void(0,k.n4)(b,400,"No changes provided",c);let{data:w,error:x}=await e.supabaseAdmin.from("intakes").select("id, firm_id, status, submitted_at, raw_payload, updated_at").eq("id",q).eq("firm_id",l.payload.firm_id).maybeSingle();if(x)return void(0,k.n4)(b,500,"Unable to load intake",c);if(!w)return void(0,k.n4)(b,404,"Intake not found",c);if(w.submitted_at||"submitted"===w.status)return b.status(409).json({ok:!1,locked:!0,requestId:c});let y=w.updated_at??null;if(Object.keys(u).length>0){let a=m(w.raw_payload)?w.raw_payload:{},{merged:d}=(0,h.b)(a,u,p),f=(0,j.e)(d),g={raw_payload:f};void 0!==u.intake_channel&&(g.intake_channel=n(u.intake_channel)),void 0!==u.matter_type&&(g.matter_type=n(u.matter_type)),void 0!==u.urgency_level&&(g.urgency_level=n(u.urgency_level)),void 0!==u.language_preference&&(g.language_preference=n(u.language_preference));let i=function(a){let b=n(a.client_first_name),c=n(a.client_last_name);return(b||c)&&[b,c].filter(Boolean).join(" ").trim()||null}(f);i&&(g.client_display_name=i);let{data:o,error:r}=await e.supabaseAdmin.from("intakes").update(g).eq("id",q).eq("firm_id",l.payload.firm_id).is("submitted_at",null).select("id, updated_at").maybeSingle();if(r)return r.message.includes("INTAKE_IMMUTABLE")?b.status(409).json({ok:!1,locked:!0,requestId:c}):void(0,k.n4)(b,500,"Unable to save intake",c);if(!o)return b.status(409).json({ok:!1,locked:!0,requestId:c});y="string"==typeof o.updated_at?o.updated_at:y}let z=null;if(s.rows.length>0){let a=async()=>{let{startSeq:a,lastSeq:b}=await (0,g.l)(e.supabaseAdmin,q,l.payload.firm_id,s.rows.length);return{messageRows:s.rows.map((b,c)=>({firm_id:l.payload.firm_id,intake_id:q,seq:a+c,source:b.source,channel:b.channel,content:b.content,content_structured:b.content_structured??{}})),allocatedLastSeq:b}},d=await a(),{error:f}=await e.supabaseAdmin.from("intake_messages").insert(d.messageRows);if(f?.code==="23505"&&(d=await a(),{error:f}=await e.supabaseAdmin.from("intake_messages").insert(d.messageRows)),f)return void(0,k.n4)(b,500,"Unable to save messages",c);z=d.allocatedLastSeq}if(t.rows.length>0){let a=t.rows.map(a=>({firm_id:l.payload.firm_id,intake_id:q,storage_object_path:a.storage_object_path,document_type:a.document_type??null,classification:a.classification??{}})),{error:d}=await e.supabaseAdmin.from("intake_documents").insert(a);if(d)return void(0,k.n4)(b,500,"Unable to save documents",c)}return b.status(200).json({ok:!0,updated_at:y,last_seq:z})}d()}catch(a){d(a)}})},9991:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(8003),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/intake/save",pathname:"/api/intake/save",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/intake/save"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/intake/save",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929,819],()=>b(b.s=9991));module.exports=c})();