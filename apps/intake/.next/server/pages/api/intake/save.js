"use strict";(()=>{var a={};a.id=977,a.ids=[977],a.modules={1046:(a,b,c)=>{c.d(b,{FS:()=>i,RE:()=>f,Y2:()=>j,at:()=>g,n4:()=>h});var d=c(5511),e=c.n(d);function f(a){let b=a.headers["x-request-id"]??a.headers["x-correlation-id"];if(Array.isArray(b)){let a=b.find(a=>a.trim());if(a)return a.trim()}return"string"==typeof b&&b.trim()?b.trim():e().randomUUID()}function g(a,b){let c=a.url?a.url.split("?")[0]:"";console.info(`[intake-api] ${a.method??"UNKNOWN"} ${c} requestId=${b}`)}function h(a,b,c,d,e){let f=e?` detail="${e}"`:"";return console.error(`[intake-api] requestId=${d} status=${b} message="${c}"${f}`),a.status(b).json({ok:!1,error:c,requestId:d})}function i(a,b,c,d){return!!a.method&&!!c.includes(a.method)||(b.setHeader("Allow",c),h(b,405,"Method not allowed",d),!1)}function j(a,b,c={}){let d=c.limitBytes??1048576,e=a.body??(c.allowEmpty?{}:void 0);if(void 0===e)return{ok:!1,status:400,error:"Request body required"};if("string"==typeof e){if(Buffer.byteLength(e,"utf8")>d)return{ok:!1,status:413,error:"Request body too large"};try{return{ok:!0,data:JSON.parse(e)}}catch{return{ok:!1,status:400,error:"Invalid JSON body"}}}return Buffer.byteLength(JSON.stringify(e),"utf8")>d?{ok:!1,status:413,error:"Request body too large"}:{ok:!0,data:e}}},2977:(a,b,c)=>{c.d(b,{C:()=>i,x:()=>j});var d=c(5511),e=c.n(d);let f=function(a){let b=process.env[a];if(!b)throw Error(`Missing ${a}`);return b}("INTAKE_TOKEN_SECRET");function g(a){return("string"==typeof a?Buffer.from(a,"utf8"):a).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function h(a){return g(e().createHmac("sha256",f).update(a).digest())}function i(a){let b=Math.floor(Date.now()/1e3)+(a.expiresInSeconds??2592e3),c=g(JSON.stringify({firm_id:a.firmId,intake_id:a.intakeId,exp:b,v:1})),d=h(c);return`${c}.${d}`}function j(a){let b,c=a.split(".");if(2!==c.length)return{ok:!1,status:401,error:"Invalid intake token"};let[d,f]=c,g=h(d),i=Buffer.from(f,"utf8"),j=Buffer.from(g,"utf8");if(i.length!==j.length||!e().timingSafeEqual(i,j))return{ok:!1,status:401,error:"Invalid intake token"};try{b=JSON.parse((function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=b.padEnd(4*Math.ceil(b.length/4),"=");return Buffer.from(c,"base64")})(d).toString("utf8"))}catch{return{ok:!1,status:401,error:"Invalid intake token"}}return b.firm_id&&b.intake_id&&"number"==typeof b.exp&&1===b.v?b.exp<=Math.floor(Date.now()/1e3)?{ok:!1,status:403,error:"Intake token expired"}:{ok:!0,payload:b}:{ok:!1,status:401,error:"Invalid intake token"}}},3721:a=>{a.exports=import("@supabase/supabase-js")},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6728:(a,b,c)=>{c.d(b,{b:()=>d});function d(a,b,c){let d=[],e={...a};for(let[a,f]of Object.entries(b)){if(!c.has(a)){d.push(a);continue}void 0!==f&&(e[a]=f)}return{merged:e,unknownKeys:d}}},7428:(a,b,c)=>{c.d(b,{e:()=>h});let d=new Set(c(5735).U.sections.flatMap(a=>a.fields.map(a=>a.key)));function e(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function f(a){if("string"!=typeof a)return;let b=a.trim();return b.length>0?b:void 0}function g(a,b){let c={};if(e(a)){for(let b of["line1","line2","city","state","zip"]){let d=f(a[b]);d&&(c[b]=d)}if(!c.line1){let b=f(a.freeform);b&&(c.line1=b)}}else{let b=f(a);b&&(c.line1=b)}if(b){let a=f(b.city),d=f(b.state),e=f(b.zip);a&&!c.city&&(c.city=a),d&&!c.state&&(c.state=d),e&&!c.zip&&(c.zip=e)}return Object.keys(c).length>0?c:null}function h(a){if(!e(a))return{};let b={},c={...e(a._legacy)?a._legacy:{},...e(a._legacy_notes)?a._legacy_notes:{}},f=(a,b)=>{void 0!==b&&void 0===c[a]&&(c[a]=b)};for(let[c,e]of Object.entries(a))d.has(c)&&(b[c]=e);if(void 0===b.opposing_address_known&&void 0!==a.opposing_known_address&&(b.opposing_address_known=a.opposing_known_address),void 0===b.opposing_last_known_address){let c=g(a.opposing_address);c&&(b.opposing_last_known_address=c)}else if(e(b.opposing_last_known_address)&&a.opposing_address){let c=g(a.opposing_address);c&&(b.opposing_last_known_address={...c,...b.opposing_last_known_address})}if(void 0===b.client_address){let c=g(a.client_address,{city:a.client_city,state:a.client_state,zip:a.client_zip});c&&(b.client_address=c)}else if(e(b.client_address)){let c=g(a.client_address,{city:a.client_city,state:a.client_state,zip:a.client_zip});c&&(b.client_address={...c,...b.client_address})}if(void 0===b.special_needs&&void 0!==a.child_special_needs&&(b.special_needs=a.child_special_needs),void 0===b.prior_custody_orders&&void 0!==a.prior_custody_cases&&(b.prior_custody_orders=a.prior_custody_cases),void 0===b.amount&&void 0!==a.estimated_balance&&(b.amount=a.estimated_balance),void 0===b.opposing_income_known&&void 0!==a.opposing_income_estimated){let c=a.opposing_income_estimated;"number"!=typeof c||Number.isNaN(c)||(b.opposing_income_known=!0),f("opposing_income_estimated",c)}for(let[c,e]of(void 0===b.support_requested&&"string"==typeof a.support_type&&(b.support_requested=a.support_type),"boolean"==typeof a.support_requested&&(f("support_requested_boolean",a.support_requested),"string"!=typeof b.support_requested&&(b.support_requested=null)),void 0!==a.opposing_phone&&f("opposing_phone",a.opposing_phone),void 0!==a.opposing_email&&f("opposing_email",a.opposing_email),void 0!==a.marriage_notes&&f("marriage_notes",a.marriage_notes),void 0!==a.fault_ground_detail&&f("fault_ground_detail",a.fault_ground_detail),void 0!==a.separation_status&&f("separation_status",a.separation_status),void 0!==a.child_school_info&&f("child_school_info",a.child_school_info),void 0!==a.current_order_exists&&f("current_order_exists",a.current_order_exists),void 0!==a.other_parent_involvement&&f("other_parent_involvement",a.other_parent_involvement),void 0!==a.asset_description&&f("asset_description",a.asset_description),void 0!==a.documentation_provided&&f("documentation_provided",a.documentation_provided),void 0!==a.ownership_dispute&&f("ownership_dispute",a.ownership_dispute),void 0!==a.income_notes&&f("income_notes",a.income_notes),void 0!==a.debt_description&&f("debt_description",a.debt_description),void 0!==a.estimated_balance&&f("estimated_balance",a.estimated_balance),void 0!==a.joint_debt&&f("joint_debt",a.joint_debt),void 0!==a.dv_description&&f("dv_description",a.dv_description),void 0!==a.weapons_present&&f("weapons_present",a.weapons_present),void 0!==a.venue_notes&&f("venue_notes",a.venue_notes),void 0!==a.prior_protective_orders&&f("prior_protective_orders",a.prior_protective_orders),void 0!==a.prior_case_notes&&f("prior_case_notes",a.prior_case_notes),void 0!==a.desired_custody_outcome&&f("desired_custody_outcome",a.desired_custody_outcome),void 0!==a.desired_property_outcome&&f("desired_property_outcome",a.desired_property_outcome),void 0!==a.other_requests&&f("other_requests",a.other_requests),void 0!==a.uploaded_document_links&&f("uploaded_document_links",a.uploaded_document_links),void 0!==a.evidence_notes&&f("evidence_notes",a.evidence_notes),void 0!==a.client_city&&f("client_city",a.client_city),void 0!==a.client_state&&f("client_state",a.client_state),void 0!==a.client_zip&&f("client_zip",a.client_zip),void 0!==a.opposing_known_address&&f("opposing_known_address",a.opposing_known_address),void 0!==a.opposing_address&&f("opposing_address",a.opposing_address),Object.entries(a)))d.has(c)||"_legacy_notes"===c||"_legacy"===c||f(c,e);return Object.keys(c).length>0&&(b._legacy=c),b}},7739:(a,b,c)=>{c.d(b,{l:()=>d});async function d(a,b,c,d){if(d<=0)return{startSeq:0,lastSeq:0};let{data:e,error:f}=await a.from("intake_messages").select("seq").eq("intake_id",b).eq("firm_id",c).order("seq",{ascending:!1}).limit(1).maybeSingle();if(f)throw Error("Unable to allocate message sequence");let g=("number"==typeof e?.seq?e.seq:0)+1;return{startSeq:g,lastSeq:g+d-1}}},8003:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>o});var e=c(7489),f=c(2977),g=c(7739),h=c(6728),i=c(5735),j=c(7428),k=c(1046),l=a([e]);e=(l.then?(await l)():l)[0];let p=new Set(i.U.sections.flatMap(a=>a.fields.filter(a=>!a.isSystem).map(a=>a.key)));function m(a){return!!a&&"object"==typeof a&&!Array.isArray(a)}function n(a){if("string"!=typeof a)return null;let b=a.trim();return b.length>0?b:null}async function o(a,b){let c=(0,k.RE)(a);if((0,k.at)(a,c),!(0,k.FS)(a,b,["POST"],c))return;let d=(0,k.Y2)(a,c);if(!d.ok)return void(0,k.n4)(b,d.status,d.error,c);let i=function(a,b){let c=a.headers.authorization;if(c?.startsWith("Bearer "))return c.slice(7).trim();let d=a.headers["x-intake-token"];if("string"==typeof d&&d.trim())return d.trim();let e=a.query.token;if("string"==typeof e&&e.trim())return e.trim();let f=b?.token;return"string"==typeof f&&f.trim()?f.trim():""}(a,d.data);if(!i)return void(0,k.n4)(b,401,"Missing intake token",c);let l=(0,f.x)(i);if(!l.ok)return void(0,k.n4)(b,l.status,l.error,c);let o=d.data??{},q="string"==typeof o.intakeId?o.intakeId:"";if(!q)return void(0,k.n4)(b,400,"intakeId is required",c);if(q!==l.payload.intake_id)return void(0,k.n4)(b,403,"Intake token does not match intake",c);let r=o.patch??{};if(!m(r))return void(0,k.n4)(b,400,"patch must be an object",c);let s=function(a){if(void 0===a)return{rows:[]};if(!Array.isArray(a))return{error:"messages must be an array"};let b=[];for(let c of a){if(!m(c))return{error:"messages entries must be objects"};if("string"!=typeof c.source||!c.source.trim())return{error:"messages.source is required"};if("string"!=typeof c.channel||!c.channel.trim())return{error:"messages.channel is required"};if("string"!=typeof c.content||!c.content.trim())return{error:"messages.content is required"};let a=m(c.content_structured)?c.content_structured:void 0;b.push({source:c.source.trim(),channel:c.channel.trim(),content:c.content,content_structured:a})}return{rows:b}}(o.messages);if("error"in s)return void(0,k.n4)(b,400,s.error,c);let t=function(a){if(void 0===a)return{rows:[]};if(!Array.isArray(a))return{error:"documents must be an array"};let b=[];for(let c of a){if(!m(c))return{error:"documents entries must be objects"};if("string"!=typeof c.storage_object_path||!c.storage_object_path.trim())return{error:"documents.storage_object_path is required"};let a="string"==typeof c.document_type?c.document_type.trim():void 0,d=m(c.classification)?c.classification:void 0;b.push({storage_object_path:c.storage_object_path.trim(),document_type:a,classification:d})}return{rows:b}}(o.documents);if("error"in t)return void(0,k.n4)(b,400,t.error,c);let{merged:u,unknownKeys:v}=(0,h.b)({},r,p);if(v.length>0)return void(0,k.n4)(b,400,`Unknown intake fields: ${v.join(", ")}`,c);if(0===Object.keys(u).length&&0===s.rows.length&&0===t.rows.length)return void(0,k.n4)(b,400,"No changes provided",c);let{data:w,error:x}=await e.supabaseAdmin.from("intakes").select("id, firm_id, status, submitted_at, raw_payload, updated_at").eq("id",q).eq("firm_id",l.payload.firm_id).maybeSingle();if(x)return void(0,k.n4)(b,500,"Unable to load intake",c);if(!w)return void(0,k.n4)(b,404,"Intake not found",c);if(w.submitted_at||"submitted"===w.status)return b.status(409).json({ok:!1,locked:!0,requestId:c});let y=w.updated_at??null;if(Object.keys(u).length>0){let a=m(w.raw_payload)?w.raw_payload:{},{merged:d}=(0,h.b)(a,u,p),f=(0,j.e)(d),g={raw_payload:f};void 0!==u.intake_channel&&(g.intake_channel=n(u.intake_channel)),void 0!==u.matter_type&&(g.matter_type=n(u.matter_type)),void 0!==u.urgency_level&&(g.urgency_level=n(u.urgency_level)),void 0!==u.language_preference&&(g.language_preference=n(u.language_preference));let i=function(a){let b=n(a.client_first_name),c=n(a.client_last_name);return(b||c)&&[b,c].filter(Boolean).join(" ").trim()||null}(f);i&&(g.client_display_name=i);let{data:o,error:r}=await e.supabaseAdmin.from("intakes").update(g).eq("id",q).eq("firm_id",l.payload.firm_id).is("submitted_at",null).select("id, updated_at").maybeSingle();if(r)return r.message.includes("INTAKE_IMMUTABLE")?b.status(409).json({ok:!1,locked:!0,requestId:c}):void(0,k.n4)(b,500,"Unable to save intake",c);if(!o)return b.status(409).json({ok:!1,locked:!0,requestId:c});y="string"==typeof o.updated_at?o.updated_at:y}let z=null;if(s.rows.length>0){let a=async()=>{let{startSeq:a,lastSeq:b}=await (0,g.l)(e.supabaseAdmin,q,l.payload.firm_id,s.rows.length);return{messageRows:s.rows.map((b,c)=>({firm_id:l.payload.firm_id,intake_id:q,seq:a+c,source:b.source,channel:b.channel,content:b.content,content_structured:b.content_structured??{}})),allocatedLastSeq:b}},d=await a(),{error:f}=await e.supabaseAdmin.from("intake_messages").insert(d.messageRows);if(f?.code==="23505"&&(d=await a(),{error:f}=await e.supabaseAdmin.from("intake_messages").insert(d.messageRows)),f)return void(0,k.n4)(b,500,"Unable to save messages",c);z=d.allocatedLastSeq}if(t.rows.length>0){let a=t.rows.map(a=>({firm_id:l.payload.firm_id,intake_id:q,storage_object_path:a.storage_object_path,document_type:a.document_type??null,classification:a.classification??{}})),{error:d}=await e.supabaseAdmin.from("intake_documents").insert(a);if(d)return void(0,k.n4)(b,500,"Unable to save documents",c)}return b.status(200).json({ok:!0,updated_at:y,last_seq:z})}d()}catch(a){d(a)}})},9991:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(8003),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/intake/save",pathname:"/api/intake/save",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/intake/save"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/intake/save",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929,539],()=>b(b.s=9991));module.exports=c})();