(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[340],{1320:(e,t,r)=>{"use strict";function a(e){if("string"!=typeof e)return null;let t=e.toLowerCase();return"admin"===t||"attorney"===t||"staff"===t?t:null}function n(e){let t=a(e);return"admin"===t||"attorney"===t}function l(e){let t=a(e);return"admin"===t||"attorney"===t}function o(e){let t=a(e);return"admin"===t||"attorney"===t}function s(e){return"admin"===a(e)}r.d(t,{TX:()=>l,Ue:()=>n,gL:()=>o,jR:()=>s})},3668:(e,t,r)=>{"use strict";r.d(t,{b:()=>s});var a=r(5729),n=r(5054),l=r(8638);let o="free";function s(){let{state:e}=(0,l._)(),[t,r]=(0,a.useState)({plan:o,loading:!0,error:null}),s=(0,a.useCallback)(async()=>{var t;if(!e.authed||!e.firmId)return void r({plan:o,loading:!1,error:null});r(e=>({...e,loading:!0,error:null}));let{data:a,error:l}=await n.N.from("firms").select("plan").eq("id",e.firmId).single();if(l)return void r({plan:o,loading:!1,error:l.message});r({plan:null!=(t=null==a?void 0:a.plan)?t:o,loading:!1,error:null})},[e.authed,e.firmId]);return(0,a.useEffect)(()=>{s()},[s]),t}},5669:(e,t,r)=>{e.exports=r(4807)},6660:(e,t,r)=>{"use strict";r.d(t,{HK:()=>a,Z8:()=>l,nh:()=>s,wq:()=>o});let a={free:{maxCases:25,maxMembers:3,maxDocuments:200},pro:null,enterprise:null};function n(e){return null===a[e]}function l(e){return n(e.plan)?{ok:!0}:e.currentCaseCount>=a[e.plan].maxCases?{ok:!1,reason:"Case limit reached for Free plan (".concat(a[e.plan].maxCases,").")}:{ok:!0}}function o(e){return n(e.plan)?{ok:!0}:e.currentMemberCount>=a[e.plan].maxMembers?{ok:!1,reason:"Member limit reached for Free plan (".concat(a[e.plan].maxMembers,").")}:{ok:!0}}function s(e){return n(e.plan)?{ok:!0}:e.currentDocumentCount>=a[e.plan].maxDocuments?{ok:!1,reason:"Document limit reached for Free plan (".concat(a[e.plan].maxDocuments,").")}:{ok:!0}}},8177:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/myclient/documents",function(){return r(8585)}])},8585:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>h});var a=r(6029),n=r(5669),l=r.n(n),o=r(2203),s=r.n(o),d=r(5729),i=r(8638),c=r(5054),u=r(1320),m=r(9845),p=r(3668),x=r(6660);function h(){var e;let{state:t}=(0,i._)(),{plan:r,loading:n}=(0,p.b)(),[o,h]=(0,d.useState)([]),[f,g]=(0,d.useState)([]),[v,b]=(0,d.useState)(!1),[y,_]=(0,d.useState)(null),[w,j]=(0,d.useState)(""),[N,k]=(0,d.useState)(null),[C,S]=(0,d.useState)("all"),[D,I]=(0,d.useState)(""),[F,E]=(0,d.useState)(null),[M,P]=(0,d.useState)(""),[T,L]=(0,d.useState)("other"),[U,A]=(0,d.useState)(""),[Y,q]=(0,d.useState)(null),[O,X]=(0,d.useState)(null),B=(0,u.TX)(t.role),R=(0,u.gL)(t.role),z=(0,x.nh)({plan:r,currentDocumentCount:o.length}),H=!n&&!z.ok,J=e=>{if(!e)return!1;let t=e.toLowerCase();return t.includes("permission")||t.includes("policy")||t.includes("not allowed")},K=(0,d.useMemo)(()=>{let e=new Map;return f.forEach(t=>e.set(t.id,t)),e},[f]),Z=(0,d.useMemo)(()=>Array.from(new Set(o.map(e=>e.doc_type).filter(Boolean))).sort(),[o]),G=(0,d.useMemo)(()=>{let e=w.trim().toLowerCase(),t=D.trim().toLowerCase();return o.filter(r=>("all"===C||r.doc_type===C)&&(!e||!!(r.display_name||r.filename).toLowerCase().includes(e))&&(!t||!!r.tags.map(e=>e.toLowerCase()).includes(t))&&!0)},[o,w,C,D]);(0,d.useEffect)(()=>{if(!t.authed||!t.firmId)return;let e=!0;return(async()=>{b(!0),_(null);let{data:r,error:a}=await c.N.from("case_documents").select("id, case_id, filename, display_name, doc_type, tags, storage_path, created_at").eq("firm_id",t.firmId).is("deleted_at",null).not("storage_path","is",null).order("created_at",{ascending:!1});if(!e)return;if(a){_(a.message),b(!1);return}let n=(null!=r?r:[]).map(e=>{var t,r,a;return{...e,display_name:null!=(t=e.display_name)?t:null,doc_type:null!=(r=e.doc_type)?r:"other",tags:null!=(a=e.tags)?a:[]}}),l=Array.from(new Set(n.map(e=>e.case_id))),o=[];if(l.length>0){let{data:e,error:t}=await c.N.from("cases").select("id, title, client_first_name, client_last_name").in("id",l);if(t){_(t.message),b(!1);return}o=null!=e?e:[]}e&&(h(n),g(o),b(!1))})(),()=>{e=!1}},[t.authed,t.firmId]);let Q=async e=>{k(e),_(null);try{let t=o.find(t=>t.id===e);if(!(null==t?void 0:t.storage_path))return void _("Document is missing a storage path.");let{data:r,error:a}=await c.N.storage.from("case-documents").createSignedUrl(t.storage_path,60);if(a||!(null==r?void 0:r.signedUrl))return void _((null==a?void 0:a.message)||"Unable to generate download link.");window.open(r.signedUrl,"_blank","noopener,noreferrer")}catch(e){_(e instanceof Error?e.message:"Unable to download document.")}finally{k(null)}},V=async e=>{if(X(null),q(null),!B)return void q("You don’t have permission to perform this action. Please contact your firm admin.");let r=U.split(",").map(e=>e.trim()).filter(e=>e.length>0),a=o.find(t=>t.id===e),{error:n}=await c.N.from("case_documents").update({display_name:M.trim()||null,doc_type:T,tags:r}).eq("id",e);if(n)return void q(J(n.message)?"You don’t have permission to perform this action. Please contact your firm admin.":n.message);h(t=>t.map(t=>t.id===e?{...t,display_name:M.trim()||null,doc_type:T,tags:r}:t)),a&&((a.display_name||a.filename)!==M.trim()&&await (0,m.M)(c.N,{firm_id:t.firmId,case_id:a.case_id,actor_user_id:t.userId,event_type:"document_renamed",message:"Document renamed: ".concat(a.display_name||a.filename," → ").concat(M.trim()),metadata:{document_id:e}}),(a.doc_type!==T||a.tags.join(",")!==r.join(","))&&await (0,m.M)(c.N,{firm_id:t.firmId,case_id:a.case_id,actor_user_id:t.userId,event_type:"document_updated",message:"Document updated: ".concat(M.trim()||a.filename),metadata:{document_id:e}})),X("Saved"),E(null)},W=async e=>{var t;if(X(null),q(null),!R)return void q("You don’t have permission to perform this action. Please contact your firm admin.");if(!window.confirm("Delete this document? This cannot be undone."))return;let{data:r,error:a}=await c.N.auth.getSession();if(a||!(null==(t=r.session)?void 0:t.access_token))return void q((null==a?void 0:a.message)||"Please sign in.");let n=await fetch("/api/myclient/documents/delete",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r.session.access_token)},body:JSON.stringify({documentId:e})}),l=await n.json().catch(()=>({}));if(!n.ok||!l.ok)return void q(J(l.error)?"You don’t have permission to perform this action. Please contact your firm admin.":l.error||"Unable to delete document.");h(t=>t.filter(t=>t.id!==e)),X("Deleted")};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l(),{children:(0,a.jsx)("title",{children:"MyClient | Documents"})}),(0,a.jsxs)("div",{className:"mx-auto max-w-6xl rounded-2xl border border-[color:var(--border)] bg-[var(--surface-1)] p-8 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between",children:[(0,a.jsx)(s(),{href:"/myclient/app",className:"text-sm text-[color:var(--muted)] hover:text-white transition",children:"← Back"}),(0,a.jsx)("h1",{className:"text-3xl font-semibold text-white",children:"Documents"})]}),(0,a.jsxs)("p",{className:"mt-2 text-sm text-[color:var(--muted)]",children:["Firm ",t.firmId?t.firmId.slice(0,8):"No firm"," \xb7 Role ",null!=(e=t.role)?e:"member"]}),t.loading&&(0,a.jsx)("p",{className:"mt-6 text-[color:var(--muted)]",children:"Loading..."}),!t.loading&&!t.authed&&(0,a.jsx)("p",{className:"mt-6 text-[color:var(--muted)]",children:"Please sign in."}),!t.loading&&t.authed&&!t.firmId&&(0,a.jsx)("p",{className:"mt-6 text-[color:var(--muted)]",children:"No firm linked yet."}),t.authed&&t.firmId&&(0,a.jsxs)("div",{className:"mt-6 space-y-4",children:[(0,a.jsxs)("div",{className:"grid gap-3 sm:grid-cols-3",children:[(0,a.jsx)("input",{value:w,onChange:e=>j(e.target.value),placeholder:"Search by filename",className:"w-full rounded-lg border border-[color:var(--border)] bg-[var(--surface-0)] px-4 py-2 text-sm text-[color:var(--text)] placeholder:text-[color:var(--muted-2)] outline-none focus:ring-2 focus:ring-[color:var(--accent)]"}),(0,a.jsx)("label",{htmlFor:"docTypeFilter",className:"sr-only",children:"Filter by document type"}),(0,a.jsxs)("select",{id:"docTypeFilter",value:C,onChange:e=>S(e.target.value),className:"w-full rounded-lg border border-[color:var(--border)] bg-[var(--surface-0)] px-3 py-2 text-sm text-[color:var(--text)] outline-none focus:ring-2 focus:ring-[color:var(--accent)]",children:[(0,a.jsx)("option",{value:"all",children:"Type: All"}),Z.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]}),(0,a.jsx)("input",{value:D,onChange:e=>I(e.target.value),placeholder:"Filter by tag",className:"w-full rounded-lg border border-[color:var(--border)] bg-[var(--surface-0)] px-4 py-2 text-sm text-[color:var(--text)] placeholder:text-[color:var(--muted-2)] outline-none focus:ring-2 focus:ring-[color:var(--accent)]"})]}),y&&(0,a.jsx)("div",{className:"rounded-lg border border-red-400/30 bg-red-500/10 px-4 py-2 text-sm text-red-200",children:y}),Y&&(0,a.jsx)("div",{className:"rounded-lg border border-red-400/30 bg-red-500/10 px-4 py-2 text-sm text-red-200",children:Y}),O&&(0,a.jsx)("div",{className:"rounded-lg border border-[color:var(--border)] bg-[var(--surface-0)] px-4 py-2 text-sm text-white",children:O}),H&&(0,a.jsxs)("div",{className:"rounded-lg border border-[color:var(--border)] bg-[var(--surface-0)] px-4 py-2 text-sm text-[color:var(--muted)]",children:[z.reason," Upgrade to Pro to upload more documents.",(0,a.jsx)(s(),{href:"/myclient/upgrade",className:"ml-2 text-white underline underline-offset-4",children:"Upgrade"})]}),!B&&(0,a.jsx)("div",{className:"rounded-lg border border-[color:var(--border)] bg-[var(--surface-0)] px-4 py-2 text-sm text-[color:var(--muted)]",children:"You have read-only access. Please contact your firm admin to manage documents."}),(0,a.jsx)("div",{className:"overflow-hidden rounded-2xl border border-[color:var(--border)]",children:v?(0,a.jsx)("p",{className:"px-4 py-6 text-[color:var(--muted)]",children:"Loading..."}):0===G.length?(0,a.jsx)("p",{className:"px-4 py-6 text-[color:var(--muted)]",children:"No documents uploaded yet."}):(0,a.jsxs)("table",{className:"min-w-full divide-y divide-white/10 text-left text-sm",children:[(0,a.jsx)("thead",{className:"text-[color:var(--muted)]",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 font-semibold",children:"File"}),(0,a.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Case"}),(0,a.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Type"}),(0,a.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Tags"}),(0,a.jsx)("th",{className:"px-4 py-3 font-semibold",children:"Uploaded"}),(0,a.jsx)("th",{className:"px-4 py-3 font-semibold text-right",children:"Action"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5 text-[color:var(--text-1)]",children:G.map(e=>{var t;let r=K.get(e.case_id),n=(null==r?void 0:r.title)||((null==r?void 0:r.client_last_name)||(null==r?void 0:r.client_first_name)?"".concat(null!=(t=null==r?void 0:r.client_last_name)?t:"").concat((null==r?void 0:r.client_first_name)?", ".concat(null==r?void 0:r.client_first_name):"").trim():"Unknown case"),l=e.display_name||e.filename,o=e.tags.length>0?e.tags.slice(0,2).join(", "):"—";return(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"px-4 py-3 text-white",children:F===e.id?(0,a.jsx)("input",{value:M,onChange:e=>P(e.target.value),disabled:!B,className:"w-full rounded-md border border-[color:var(--border)] bg-[var(--surface-0)] px-2 py-1 text-sm text-white outline-none",placeholder:"Enter document name"}):l}),(0,a.jsx)("td",{className:"px-4 py-3",children:(0,a.jsx)(s(),{href:"/myclient/cases/".concat(e.case_id),className:"text-[color:var(--muted)] hover:text-white",children:n})}),(0,a.jsx)("td",{className:"px-4 py-3 capitalize",children:F===e.id?(0,a.jsx)("input",{value:T,onChange:e=>L(e.target.value),disabled:!B,className:"w-full rounded-md border border-[color:var(--border)] bg-[var(--surface-0)] px-2 py-1 text-sm text-white outline-none",placeholder:"Enter document type"}):e.doc_type}),(0,a.jsx)("td",{className:"px-4 py-3 text-[color:var(--muted)]",children:F===e.id?(0,a.jsx)("input",{value:U,onChange:e=>A(e.target.value),disabled:!B,className:"w-full rounded-md border border-[color:var(--border)] bg-[var(--surface-0)] px-2 py-1 text-sm text-white outline-none",placeholder:"Enter tags (comma-separated)"}):(0,a.jsxs)(a.Fragment,{children:[o,e.tags.length>2&&" +".concat(e.tags.length-2)]})}),(0,a.jsx)("td",{className:"px-4 py-3 text-[color:var(--muted)]",children:new Date(e.created_at).toLocaleDateString()}),(0,a.jsx)("td",{className:"px-4 py-3 text-right",children:(0,a.jsx)("div",{className:"flex flex-wrap justify-end gap-2",children:F===e.id?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:()=>V(e.id),disabled:!B,className:"rounded-lg border border-[color:var(--border)] px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-[color:var(--muted)] hover:text-white disabled:opacity-50",children:"Save"}),(0,a.jsx)("button",{onClick:()=>E(null),className:"rounded-lg border border-[color:var(--border)] px-3 py-1.5 text-xs uppercase tracking-wide text-[color:var(--muted)] hover:text-white",children:"Cancel"})]}):(0,a.jsxs)(a.Fragment,{children:[B&&(0,a.jsx)("button",{onClick:()=>{E(e.id),P(e.display_name||e.filename),L(e.doc_type||"other"),A(e.tags.join(", ")),X(null),q(null)},className:"rounded-lg border border-[color:var(--border)] px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-[color:var(--muted)] hover:text-white",children:"Rename/Edit"}),(0,a.jsx)("button",{onClick:()=>Q(e.id),disabled:N===e.id,className:"rounded-lg border border-[color:var(--border)] px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-[color:var(--muted)] hover:text-white disabled:opacity-60",children:N===e.id?"Preparing…":"Download"}),R&&(0,a.jsx)("button",{onClick:()=>W(e.id),className:"rounded-lg border border-red-400/40 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-red-200 hover:text-white",children:"Delete"})]})})})]},e.id)})})]})})]})]})]})}},9845:(e,t,r)=>{"use strict";async function a(e,t){try{var r,a,n;await e.from("case_activity").insert({firm_id:t.firm_id,case_id:null!=(r=t.case_id)?r:null,actor_user_id:null!=(a=t.actor_user_id)?a:null,event_type:t.event_type,message:t.message,metadata:null!=(n=t.metadata)?n:{}})}catch(e){}}r.d(t,{M:()=>a})}},e=>{e.O(0,[636,593,792],()=>e(e.s=8177)),_N_E=e.O()}]);