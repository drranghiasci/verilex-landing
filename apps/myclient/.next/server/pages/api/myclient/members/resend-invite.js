"use strict";(()=>{var a={};a.id=104,a.ids=[104],a.modules={2328:(a,b,c)=>{c.r(b),c.d(b,{config:()=>p,default:()=>o,handler:()=>r});var d={};c.r(d),c.d(d,{default:()=>l});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(3939),j=c(8695);let k=new Set(["admin","attorney","staff"]);async function l(a,b){if("POST"!==a.method)return b.setHeader("Allow",["POST"]),b.status(405).json({ok:!1,error:"Method not allowed"});let c=a.headers.authorization;if(!c?.startsWith("Bearer "))return b.status(401).json({ok:!1,error:"Missing authorization token"});let d=c.slice(7).trim();if(!d)return b.status(401).json({ok:!1,error:"Missing authorization token"});let e=process.env.NEXT_PUBLIC_SUPABASE_URL,f=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,g=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!f||!g)return b.status(500).json({ok:!1,error:"Missing Supabase environment variables"});let h=a.body??{},l="string"==typeof h.email?h.email.trim().toLowerCase():"",m="string"==typeof h.role?h.role:"";if(!l||!l.includes("@"))return b.status(400).json({ok:!1,error:"Valid email is required"});if(!k.has(m))return b.status(400).json({ok:!1,error:"Invalid role"});let n=(0,i.createClient)(e,f,{auth:{persistSession:!1,autoRefreshToken:!1}}),o=(0,i.createClient)(e,g,{auth:{persistSession:!1,autoRefreshToken:!1}}),{data:p,error:q}=await n.auth.getUser(d);if(q||!p.user)return b.status(401).json({ok:!1,error:"Invalid session"});let{data:r,error:s}=await o.from("firm_members").select("firm_id, role").eq("user_id",p.user.id).limit(1);if(s)return b.status(500).json({ok:!1,error:s.message});let t=Array.isArray(r)&&r.length>0?r[0]:null;if(!t?.firm_id)return b.status(403).json({ok:!1,error:"No firm membership found"});if("admin"!==t.role)return b.status(403).json({ok:!1,error:"Admin access required"});let{data:u,error:v}=await o.from("firms").select("plan").eq("id",t.firm_id).single();if(v)return b.status(500).json({ok:!1,error:v.message});let{count:w,error:x}=await o.from("firm_members").select("user_id",{count:"exact",head:!0}).eq("firm_id",t.firm_id);if(x)return b.status(500).json({ok:!1,error:x.message});let y=u?.plan??"free",z=(0,j.wq)({plan:y,currentMemberCount:w??0});if(!z.ok){try{await o.from("case_activity").insert({firm_id:t.firm_id,actor_user_id:p.user.id,event_type:"plan_limit_hit",message:"Member limit reached",metadata:{kind:"members"}})}catch{}return b.status(403).json({ok:!1,error:`${z.reason} Upgrade to Pro to add more members.`})}let{error:A}=await o.from("firm_invites").upsert({firm_id:t.firm_id,email:l,role:m,status:"pending",accepted_at:null},{onConflict:"firm_id,email"});if(A)return b.status(500).json({ok:!1,error:A.message});let{error:B}=await o.auth.admin.inviteUserByEmail(l,{redirectTo:"https://myclient.verilex.us/auth/callback"});if(B){let a=B.message||"Unable to send invite.";return a.toLowerCase().includes("user")&&a.toLowerCase().includes("already")?b.status(400).json({ok:!1,error:"User already registered. Ask them to sign in and use Finalize Firm Access if needed."}):b.status(500).json({ok:!1,error:a})}try{await o.from("case_activity").insert({firm_id:t.firm_id,case_id:null,actor_user_id:p.user.id,event_type:"invite_resent",message:`Resent invite to ${l}`,metadata:{email:l,role:m}})}catch{}return b.status(200).json({ok:!0})}var m=c(9275),n=c(879);let o=(0,h.M)(d,"default"),p=(0,h.M)(d,"config"),q=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/myclient/members/resend-invite",pathname:"/api/myclient/members/resend-invite",bundlePath:"",filename:""},userland:d,distDir:".next",relativeProjectDir:""});async function r(a,b,c){let d=await q.prepare(a,b,{srcPage:"/api/myclient/members/resend-invite"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,m.getTracer)(),e=d.getActiveScopeSpan(),j=q.instrumentationOnRequestError.bind(q),k=async e=>q.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:q.isDev,page:"/api/myclient/members/resend-invite",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>j(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==n.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await k(e):await d.withPropagatedContext(a.headers,()=>d.trace(n.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:m.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},k))}catch(a){if(q.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}},3939:a=>{a.exports=require("@supabase/supabase-js")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8695:(a,b,c)=>{c.d(b,{Z8:()=>f,nh:()=>h,wq:()=>g});let d={free:{maxCases:25,maxMembers:3,maxDocuments:200},pro:null,enterprise:null};function e(a){return null===d[a]}function f(a){return e(a.plan)?{ok:!0}:a.currentCaseCount>=d[a.plan].maxCases?{ok:!1,reason:`Case limit reached for Free plan (${d[a.plan].maxCases}).`}:{ok:!0}}function g(a){return e(a.plan)?{ok:!0}:a.currentMemberCount>=d[a.plan].maxMembers?{ok:!1,reason:`Member limit reached for Free plan (${d[a.plan].maxMembers}).`}:{ok:!0}}function h(a){return e(a.plan)?{ok:!0}:a.currentDocumentCount>=d[a.plan].maxDocuments?{ok:!1,reason:`Document limit reached for Free plan (${d[a.plan].maxDocuments}).`}:{ok:!0}}}};var b=require("../../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929],()=>b(b.s=2328));module.exports=c})();