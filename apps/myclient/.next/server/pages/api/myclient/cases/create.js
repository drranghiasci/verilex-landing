"use strict";(()=>{var a={};a.id=381,a.ids=[381],a.modules={2039:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{default:()=>i});var e=c(3939),f=c(5876),g=c(8695),h=a([f]);async function i(a,b){if("POST"!==a.method)return b.setHeader("Allow",["POST"]),b.status(405).json({ok:!1,error:"Method not allowed"});let c=a.headers.authorization;if(!c?.startsWith("Bearer "))return b.status(401).json({ok:!1,error:"Missing authorization token"});let d=c.slice(7).trim();if(!d)return b.status(401).json({ok:!1,error:"Missing authorization token"});let h=process.env.NEXT_PUBLIC_SUPABASE_URL,i=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,j=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!h||!i||!j)return b.status(500).json({ok:!1,error:"Missing Supabase environment variables"});let k=a.body??{},l=f.O.safeParse({client_first_name:k.client_first_name??"",client_last_name:k.client_last_name??"",client_email:k.client_email??"",client_phone:k.client_phone??"",title:k.title??"",matter_type:k.matter_type??"",status:k.status??"",state:k.state??"",county:k.county??"",court_name:k.court_name??"",case_number:k.case_number??"",internal_notes:k.internal_notes??""});if(!l.success)return b.status(400).json({ok:!1,error:l.error.errors[0]?.message||"Invalid intake data"});let m=(0,e.createClient)(h,i,{auth:{persistSession:!1,autoRefreshToken:!1}}),n=(0,e.createClient)(h,j,{auth:{persistSession:!1,autoRefreshToken:!1}}),{data:o,error:p}=await m.auth.getUser(d);if(p||!o.user)return b.status(401).json({ok:!1,error:"Invalid session"});let{data:q,error:r}=await n.from("firm_members").select("firm_id, role").eq("user_id",o.user.id).limit(1);if(r)return b.status(500).json({ok:!1,error:r.message});let s=Array.isArray(q)&&q.length>0?q[0]:null;if(!s?.firm_id)return b.status(403).json({ok:!1,error:"No firm membership found"});if(!["admin","attorney"].includes(s.role))return b.status(403).json({ok:!1,error:"You do not have permission to create cases."});let{data:t,error:u}=await n.from("firms").select("plan").eq("id",s.firm_id).single();if(u)return b.status(500).json({ok:!1,error:u.message});let{count:v,error:w}=await n.from("cases").select("id",{count:"exact",head:!0}).eq("firm_id",s.firm_id);if(w)return b.status(500).json({ok:!1,error:w.message});let x=t?.plan??"free",y=(0,g.Z8)({plan:x,currentCaseCount:v??0});if(!y.ok){try{await n.from("case_activity").insert({firm_id:s.firm_id,actor_user_id:o.user.id,event_type:"plan_limit_hit",message:"Case limit reached",metadata:{kind:"cases"}})}catch{}return b.status(403).json({ok:!1,error:`${y.reason} Upgrade to Pro to add more cases.`})}let z=l.data,A=(0,f.l)(z),{data:B,error:C}=await n.from("cases").insert({firm_id:s.firm_id,client_name:`${z.client_first_name} ${z.client_last_name}`.trim(),client_first_name:z.client_first_name,client_last_name:z.client_last_name,client_email:z.client_email||null,client_phone:z.client_phone||null,title:A,matter_type:z.matter_type||"Divorce",status:z.status||"open",state:z.state||null,county:z.county||null,court_name:z.court_name||null,case_number:z.case_number||null,internal_notes:z.internal_notes||null,last_activity_at:new Date().toISOString()}).select("id").single();if(C||!B)return b.status(500).json({ok:!1,error:C?.message||"Unable to create case"});try{await n.from("case_activity").insert({firm_id:s.firm_id,case_id:B.id,actor_user_id:o.user.id,event_type:"case_created",message:`Case created for ${z.client_last_name}, ${z.client_first_name}`,metadata:{source:"intake"}})}catch{}return b.status(200).json({ok:!0,caseId:B.id})}f=(h.then?(await h)():h)[0],d()}catch(a){d(a)}})},2971:a=>{a.exports=import("zod")},3939:a=>{a.exports=require("@supabase/supabase-js")},5023:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(2039),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/myclient/cases/create",pathname:"/api/myclient/cases/create",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/myclient/cases/create"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/myclient/cases/create",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5876:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{O:()=>h,l:()=>g});var e=c(2971),f=a([e]);let h=(e=(f.then?(await f)():f)[0]).z.object({client_first_name:e.z.string().trim().min(1,"Client first name is required."),client_last_name:e.z.string().trim().min(1,"Client last name is required."),client_email:e.z.string().trim().email("Enter a valid email.").optional().or(e.z.literal("")),client_phone:e.z.string().trim().optional().or(e.z.literal("")),title:e.z.string().trim().optional().or(e.z.literal("")),matter_type:e.z.string().trim().optional().default("Divorce"),status:e.z.string().trim().optional().default("open"),state:e.z.string().trim().optional().or(e.z.literal("")),county:e.z.string().trim().optional().or(e.z.literal("")),court_name:e.z.string().trim().optional().or(e.z.literal("")),case_number:e.z.string().trim().optional().or(e.z.literal("")),internal_notes:e.z.string().trim().optional().or(e.z.literal(""))});function g(a){let b=(a.title??"").trim();if(b)return b;let c=(a.matter_type??"").trim()||"Matter";return`${a.client_last_name}, ${a.client_first_name} â€” ${c}`}d()}catch(a){d(a)}})},8695:(a,b,c)=>{c.d(b,{Z8:()=>f,nh:()=>h,wq:()=>g});let d={free:{maxCases:25,maxMembers:3,maxDocuments:200},pro:null,enterprise:null};function e(a){return null===d[a]}function f(a){return e(a.plan)?{ok:!0}:a.currentCaseCount>=d[a.plan].maxCases?{ok:!1,reason:`Case limit reached for Free plan (${d[a.plan].maxCases}).`}:{ok:!0}}function g(a){return e(a.plan)?{ok:!0}:a.currentMemberCount>=d[a.plan].maxMembers?{ok:!1,reason:`Member limit reached for Free plan (${d[a.plan].maxMembers}).`}:{ok:!0}}function h(a){return e(a.plan)?{ok:!0}:a.currentDocumentCount>=d[a.plan].maxDocuments?{ok:!1,reason:`Document limit reached for Free plan (${d[a.plan].maxDocuments}).`}:{ok:!0}}}};var b=require("../../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929],()=>b(b.s=5023));module.exports=c})();