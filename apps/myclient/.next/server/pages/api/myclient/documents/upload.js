"use strict";(()=>{var a={};a.id=565,a.ids=[565],a.modules={239:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(9103),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/myclient/documents/upload",pathname:"/api/myclient/documents/upload",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/myclient/documents/upload"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/myclient/documents/upload",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},1455:a=>{a.exports=require("node:fs/promises")},3939:a=>{a.exports=require("@supabase/supabase-js")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7313:a=>{a.exports=import("formidable")},7598:a=>{a.exports=require("node:crypto")},8695:(a,b,c)=>{c.d(b,{Z8:()=>f,nh:()=>h,wq:()=>g});let d={free:{maxCases:25,maxMembers:3,maxDocuments:200},pro:null,enterprise:null};function e(a){return null===d[a]}function f(a){return e(a.plan)?{ok:!0}:a.currentCaseCount>=d[a.plan].maxCases?{ok:!1,reason:`Case limit reached for Free plan (${d[a.plan].maxCases}).`}:{ok:!0}}function g(a){return e(a.plan)?{ok:!0}:a.currentMemberCount>=d[a.plan].maxMembers?{ok:!1,reason:`Member limit reached for Free plan (${d[a.plan].maxMembers}).`}:{ok:!0}}function h(a){return e(a.plan)?{ok:!0}:a.currentDocumentCount>=d[a.plan].maxDocuments?{ok:!1,reason:`Document limit reached for Free plan (${d[a.plan].maxDocuments}).`}:{ok:!0}}},9103:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>l,default:()=>k});var e=c(3939),f=c(7313),g=c(1455),h=c(7598),i=c(8695),j=a([f]);f=(j.then?(await j)():j)[0];let l={api:{bodyParser:!1}},m=/^[0-9a-fA-F-]{36}$/;async function k(a,b){var c,d;let j,k;if("POST"!==a.method)return b.setHeader("Allow",["POST"]),b.status(405).json({ok:!1,error:"Method not allowed"});let l=a.headers.authorization;if(!l?.startsWith("Bearer "))return b.status(401).json({ok:!1,error:"Missing authorization token"});let n=l.slice(7).trim();if(!n)return b.status(401).json({ok:!1,error:"Missing authorization token"});let o=process.env.NEXT_PUBLIC_SUPABASE_URL,p=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,q=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!o||!p||!q)return b.status(500).json({ok:!1,error:"Missing Supabase environment variables"});let r=(0,f.default)({multiples:!1,maxFileSize:0xf00000});try{[j,k]=await new Promise((b,c)=>{r.parse(a,(a,d,e)=>{if(a)return void c(a);b([d,e])})})}catch(c){let a=c instanceof Error?c.message:"Unable to parse upload";if(a.toLowerCase().includes("maxfile"))return b.status(413).json({ok:!1,error:"File exceeds 15MB limit."});return b.status(400).json({ok:!1,error:a})}let s=(c=j.caseId)?Array.isArray(c)?c[0]:c:null;if(!s||!m.test(s))return b.status(400).json({ok:!1,error:"Invalid case id"});let t=(d=k.file)?Array.isArray(d)?d[0]:d:null;if(!t)return b.status(400).json({ok:!1,error:"File is required"});if(t.size&&t.size>0xf00000)return b.status(413).json({ok:!1,error:"File exceeds 15MB limit."});let u=(0,e.createClient)(o,p,{auth:{persistSession:!1,autoRefreshToken:!1}}),v=(0,e.createClient)(o,q,{auth:{persistSession:!1,autoRefreshToken:!1}}),{data:w,error:x}=await u.auth.getUser(n);if(x||!w.user)return b.status(401).json({ok:!1,error:"Invalid session"});let{data:y,error:z}=await v.from("firm_members").select("firm_id, role").eq("user_id",w.user.id).limit(1);if(z)return b.status(500).json({ok:!1,error:z.message});let A=Array.isArray(y)&&y.length>0?y[0]:null;if(!A?.firm_id)return b.status(403).json({ok:!1,error:"No firm membership found"});if(!["admin","attorney"].includes(A.role))return b.status(403).json({ok:!1,error:"You do not have permission to upload documents."});let{data:B,error:C}=await v.from("firms").select("plan").eq("id",A.firm_id).single();if(C)return b.status(500).json({ok:!1,error:C.message});let{count:D,error:E}=await v.from("case_documents").select("id",{count:"exact",head:!0}).eq("firm_id",A.firm_id).is("deleted_at",null);if(E)return b.status(500).json({ok:!1,error:E.message});let F=B?.plan??"free",G=(0,i.nh)({plan:F,currentDocumentCount:D??0});if(!G.ok){try{await v.from("case_activity").insert({firm_id:A.firm_id,actor_user_id:w.user.id,event_type:"plan_limit_hit",message:"Document limit reached",metadata:{kind:"documents"}})}catch{}return b.status(403).json({ok:!1,error:`${G.reason} Upgrade to Pro to upload more documents.`})}let{data:H,error:I}=await v.from("cases").select("id, firm_id").eq("id",s).limit(1);if(I)return b.status(500).json({ok:!1,error:I.message});let J=Array.isArray(H)&&H.length>0?H[0]:null;if(!J||J.firm_id!==A.firm_id)return b.status(404).json({ok:!1,error:"Case not found"});let K=function(a){let b=a.replace(/[/\\]/g,"").trim().replace(/[^a-zA-Z0-9._-]/g,"_");return b.length>0?b:"document"}(t.originalFilename||"document"),L=`${A.firm_id}/${s}/${(0,h.randomUUID)()}-${K}`,M=await (0,g.readFile)(t.filepath),N=t.mimetype||"application/octet-stream",{error:O}=await v.storage.from("case-documents").upload(L,M,{contentType:N,upsert:!1});if(O)return b.status(500).json({ok:!1,error:O.message});let{data:P,error:Q}=await v.from("case_documents").insert({firm_id:A.firm_id,case_id:s,storage_path:L,filename:t.originalFilename||K,mime_type:t.mimetype,size_bytes:t.size??null,uploaded_by:w.user.id}).select("id, filename, created_at").single();if(Q||!P)return b.status(500).json({ok:!1,error:Q?.message||"Unable to save document"});try{await v.from("case_activity").insert({firm_id:A.firm_id,case_id:s,actor_user_id:w.user.id,event_type:"document_uploaded",message:`Document uploaded: ${P.filename}`,metadata:{file_name:P.filename}})}catch{}return b.status(200).json({ok:!0,document:P})}d()}catch(a){d(a)}})}};var b=require("../../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929],()=>b(b.s=239));module.exports=c})();